!function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=37)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Message=class{constructor(t,e){this.text=t,this.color=e}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(6),n=i(0);e.fighterFromObject=function(t){switch(t._type){case"Fighter":const e=new r(t.baseMaxHp,t.baseDefense,t.basePower);return e.currHp=t.currHp,e}return null};class r{constructor(t,e,i,o=0){this.baseDefense=e,this.basePower=i,this.xp=o,this.currHp=t,this.baseMaxHp=t}static getDefense(t){let e=t.baseDefense;return t.owner&&t.owner.equipment&&(e+=o.Equipment.getDefenseBonus(t.owner.equipment)),e}static getMaxHp(t){let e=t.baseMaxHp;return t.owner&&t.owner.equipment&&(e+=o.Equipment.getMaxHpBonus(t.owner.equipment)),e}static getPower(t){let e=t.basePower;return t.owner&&t.owner.equipment&&(e+=o.Equipment.getPowerBonus(t.owner.equipment)),e}attack(t){let e=[];if(!t||!t.fighter)return e;const i=r.getPower(this)-r.getDefense(t.fighter);return i>0?(e.push({message:new n.Message(`${this.owner.name.capitalize()} attacks ${t.name} for ${i} hit points.`,"white")}),e=e.concat(t.fighter.takeDamage(i))):e.push({message:new n.Message(`${this.owner.name.capitalize()} attacks ${t.name} but does no damage.`,"white")}),e}takeDamage(t){const e=[];return this.currHp-=t,this.currHp<=0&&e.push({dead:this.owner,xp:this.xp}),e}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Fighter",t}}e.Fighter=r},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.MAIN_HAND=0]="MAIN_HAND",t[t.OFF_HAND=1]="OFF_HAND",t[t.COUNT=2]="COUNT"}(e.EquipmentSlot||(e.EquipmentSlot={})),e.EQUIPMENTSLOTSTRINGS=["Main Hand","Off Hand"];class o{constructor(t,e,i,o){this.slot=t,this.powerBonus=e,this.defenseBonus=i,this.maxHpBonus=o}static fromOtherEquippable(t){return new o(t.slot,t.powerBonus,t.defenseBonus,t.maxHpBonus)}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Equippable",t}}e.Equippable=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(10),n=i(34),r=i(33),s=i(32),a=i(31),h=i(30),l=i(4),c=i(6),u=i(2),p=i(1),_=i(8),d=i(16),f=i(9),g=i(25),m=i(24),y=i(0),v=i(11),w=i(5),S=i(23),M=i(22);e.CONSTANTS={BAR_WIDTH:20,MAP_HEIGHT:43,MAP_WIDTH:80,MESSAGE_HEIGHT:6,MESSAGE_WIDTH:58,MESSAGE_X:22,PANEL_HEIGHT:7,PLAYER_FOV:10,SCREEN_HEIGHT:50,SCREEN_WIDTH:80,TOUCH_MOVE_REPEAT_DELAY:300};const T=["Load Game","New Game"],E=[o.VK_LEFT,o.VK_UP,o.VK_RIGHT,o.VK_DOWN,o.VK_H,o.VK_K,o.VK_L,o.VK_J,o.VK_Y,o.VK_U,o.VK_B,o.VK_N,o.VK_G,o.VK_I,o.VK_D,o.VK_C,o.VK_Z,o.VK_ESCAPE,o.VK_RETURN];let b;const x=new o.FOV.PreciseShadowcasting((t,i)=>!(t<0||t>=e.CONSTANTS.MAP_WIDTH||i<0||i>=e.CONSTANTS.MAP_HEIGHT)&&!I[C].getTile(t,i).blocksSight);let O,R,N,C=0,A=[],V=_.GameState.MAIN_MENU,D="",I=[],k=0,P=new v.MessageLog(e.CONSTANTS.MESSAGE_X,e.CONSTANTS.MESSAGE_HEIGHT,e.CONSTANTS.MESSAGE_WIDTH),L=null,H=null,F=!1;function G(t){for(const e of t){if(e.message&&P.addMessage(e.message),e.dead){let t=null;if(e.dead===L){const i=s.killPlayer(e.dead);t=i.message,V=i.state}else{t=s.killMonster(e.dead).message}P.addMessage(t)}if(e.equip){const t=c.Equipment.toggleEquip(L.equipment,e.equip.equippable);for(const e of t)e.dequipped&&P.addMessage(new y.Message(`You unequip the ${e.dequipped.name}.`,"white")),e.equipped&&P.addMessage(new y.Message(`You equip the ${e.equipped.name}.`,"white"))}if(e.itemAdded&&A.splice(A.indexOf(e.itemAdded),1),e.itemDropped&&A.push(e.itemDropped),e.targeting&&(H=_.GameState.PLAYER_TURN,V=_.GameState.TARGETING,R=[L.x,L.y]),e.xp){P.addMessage(new y.Message(`You gain ${e.xp} experience points.`,"white")),f.Level.addXp(L.level,e.xp)&&(P.addMessage(new y.Message("You have leveled up!","yellow")),H=V,V=_.GameState.LEVEL_UP,k=0)}}}function K(t,i){const o=document.querySelector("body");o.style.height=window.innerHeight+"px",o.style.widows=window.innerWidth+"px";const n=document.getElementById("grid"),r=document.getElementById("touch-icons");navigator&&(navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||/iPad|iPhone|iPod/.test(navigator.platform))?(F=!0,n.style.display="grid",r.style.display="block"):(F=!1,n.style.display="none",r.style.display="none");const s=Math.floor(window.innerHeight*e.CONSTANTS.SCREEN_HEIGHT/(e.CONSTANTS.SCREEN_HEIGHT+e.CONSTANTS.PANEL_HEIGHT)),[a,h]=t.computeSize(window.innerWidth,s);t.setOptions({height:h,width:a});const[l,c]=t.computeSize(window.innerWidth,window.innerHeight-s);i.setOptions({height:c,width:l}),P.height=c-1}function U(t,i,o){if(F&&a.drawTouchIcons(V,L,A,z),V===_.GameState.MAIN_MENU)return t.clear(),i.clear(),void m.menu(t,"Main Menu",T,k,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_HEIGHT);!function(t,i){t.clear();const o=i.x,n=i.y,s=Math.floor(t.getOptions().width/2),a=Math.floor(t.getOptions().height/2);for(let i=0;i<e.CONSTANTS.MAP_WIDTH;++i)for(let h=0;h<e.CONSTANTS.MAP_HEIGHT;++h){const e=i-o+s,l=h-n+a,c=I[C].getTile(i,h);c.isSeen&&(c.blocksSight?t.draw(e,l,"",null,r.COLORS.darkWall):t.draw(e,l,"",null,r.COLORS.darkGround))}const h=[];x.compute(i.x,i.y,e.CONSTANTS.PLAYER_FOV,(e,i,l,c)=>{h.push([e,i]);const u=e-o+s,p=i-n+a,d=I[C].getTile(e,i);d.isSeen=!0,d.blocksSight?t.draw(u,p,"",null,r.COLORS.lightWall):V===_.GameState.TARGETING&&R[0]===e&&R[1]===i?t.draw(u,p,"",null,"red"):t.draw(u,p,"",null,r.COLORS.lightGround);const f=A.filter(t=>t.x===e&&t.y===i).sort(t=>t.renderOrder);if(f.length>0){const o=f[f.length-1];V===_.GameState.TARGETING&&R[0]===e&&R[1]===i?t.draw(u,p,o.symbol,o.color,"red"):t.draw(u,p,o.symbol,o.color,r.COLORS.lightGround)}}),A.filter(t=>t.stairs).forEach(e=>{const i=e.x-o+s,l=e.y-n+a,c=I[C].getTile(e.x,e.y);c.isSeen&&(h.some(t=>t[0]===e.x&&t[1]===e.y)||t.draw(i,l,e.symbol,e.color,r.COLORS.darkGround))}),t.draw(s,a,i.symbol,i.color,r.COLORS.lightGround)}(t,o),V===_.GameState.LEVEL_UP?m.menu(t,"Level up! Choose a stat to raise:",[`HP +20 (current: ${p.Fighter.getMaxHp(L.fighter)})`,`Attack +1 (current: ${p.Fighter.getPower(L.fighter)})`,`Defense +1 (current: ${p.Fighter.getDefense(L.fighter)})`],k,40,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_HEIGHT):V===_.GameState.SHOW_CHARACTER_PANEL?n.characterScreen(t,L,50,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_HEIGHT):V===_.GameState.SHOW_INVENTORY&&m.menu(t,"Inventory",L.inventory.items.map(t=>t.equippable&&L.equipment.equipped.includes(t.equippable)?t.name+` (on ${u.EQUIPMENTSLOTSTRINGS[t.equippable.slot]})`:t.name),k,50,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_HEIGHT),q(i,o,D)}function q(t,i,o){t.clear(),i&&function(t,e,i,o,n,r,s,a,h){const l=Math.floor(r/s*o);for(let n=0;n<o;++n)t.draw(e+n,i,"",null,n<l?a:h);const c=`${n}: ${r}/${s}`;t.drawText(Math.floor(e+o/2-c.length/2),i,c)}(t,1,1,e.CONSTANTS.BAR_WIDTH,"HP",i.fighter.currHp,p.Fighter.getMaxHp(i.fighter),"red","darkred"),function(t,e){let i=1;for(const o of e.messages)t.drawText(P.x,i,`%c{${o.color}}${o.text}`,P.width),i++}(t,P),o&&t.drawText(1,0,o),t.drawText(1,2,`Floor: ${I[C].dungeonLevel}`)}function W(t){const e=t.keyCode;if(-1===E.indexOf(e))return;t.preventDefault();let i=null;switch(e){case o.VK_LEFT:case o.VK_H:i={type:"move",dir:[-1,0]};break;case o.VK_UP:case o.VK_K:i={type:"move",dir:[0,-1]};break;case o.VK_RIGHT:case o.VK_L:i={type:"move",dir:[1,0]};break;case o.VK_DOWN:case o.VK_J:i={type:"move",dir:[0,1]};break;case o.VK_Y:i={type:"move",dir:[-1,-1]};break;case o.VK_U:i={type:"move",dir:[1,-1]};break;case o.VK_B:i={type:"move",dir:[-1,1]};break;case o.VK_N:i={type:"move",dir:[1,1]};break;case o.VK_G:i={type:"pickup"};break;case o.VK_I:i={type:"open-inventory"};break;case o.VK_D:i={type:"drop"};break;case o.VK_C:i={type:"open-character-panel"};break;case o.VK_Z:i={type:"wait"};break;case o.VK_ESCAPE:i={type:"exit"};break;case o.VK_RETURN:i={type:"enter"}}z(i)}function Y(t){const i=b.eventToPosition(t);if("number"==typeof i)return;const o=Math.floor(b.getOptions().width/2),n=Math.floor(b.getOptions().height/2),r=A.filter(t=>{const e=t.x-L.x+o,r=t.y-L.y+n;return e===i[0]&&r===i[1]}).sort(t=>t.renderOrder);let s="";if(r.length>0){const t=r[r.length-1];x.compute(L.x,L.y,e.CONSTANTS.PLAYER_FOV,(e,i)=>{t.x===e&&t.y===i&&(s=t.name)})}D=s,V!==_.GameState.MAIN_MENU&&q(O,L,s)}function B(t){if(t.preventDefault(),t.touches&&t.touches.length>0){const i=t.touches[0];let o=null,n=!1;const r=[0,0];i.clientX<window.innerWidth/3?(n=!0,r[0]--):i.clientX>window.innerWidth/3*2&&(n=!0,r[0]++),i.clientY<window.innerHeight/3?(n=!0,r[1]--):i.clientY>window.innerHeight/3*2&&(n=!0,r[1]++),n?(o={type:"move",dir:r},N&&(window.clearInterval(N),N=null),N=window.setInterval(()=>{z(o)},e.CONSTANTS.TOUCH_MOVE_REPEAT_DELAY)):o=A.some(t=>t.item&&t.x===L.x&&t.y===L.y)?{type:"pickup"}:V===_.GameState.MAIN_MENU||V===_.GameState.SHOW_INVENTORY||V===_.GameState.TARGETING||V===_.GameState.LEVEL_UP||A.some(t=>t.stairs&&t.x===L.x&&t.y===L.y)?{type:"enter"}:{type:"open-inventory"},o&&z(o)}}function z(t){if(V===_.GameState.ENEMY_TURN)return;let i=[];if(V===_.GameState.LEVEL_UP)"move"===t.type?(k+=t.dir[1])<0?k=0:k>=3&&(k=2):"enter"===t.type&&(0===k?(L.fighter.baseMaxHp+=20,L.fighter.currHp+=20):1===k?L.fighter.basePower+=1:2===k&&(L.fighter.baseDefense+=1),V=_.GameState.PLAYER_TURN);else if(V===_.GameState.MAIN_MENU){if("move"===t.type)(k+=t.dir[1])<0?k=0:k>=T.length&&(k=T.length-1);else if("enter"===t.type)switch(T[k]){case"New Game":A=[],L=new l.Entity(0,e.CONSTANTS.SCREEN_WIDTH,e.CONSTANTS.SCREEN_HEIGHT,"white","私",!0,"Player",w.RenderOrder.ACTOR,new p.Fighter(100,1,2),null,null,new d.Inventory(26),null,new f.Level,new c.Equipment),A.push(L),V=_.GameState.PLAYER_TURN,I.push((new M.TutorialMapGenerator).generate({height:e.CONSTANTS.MAP_HEIGHT,width:e.CONSTANTS.MAP_WIDTH},L,A,1)),P=new v.MessageLog(e.CONSTANTS.MESSAGE_X,e.CONSTANTS.MESSAGE_HEIGHT,e.CONSTANTS.MESSAGE_WIDTH);break;case"Load Game":{const t=localStorage.getItem("savedGame");if(t){const e=JSON.parse(t),i=g.loadGame(e);C=i.currentMap,A=i.entities,I=i.gameMaps,V=i.gameState,P=i.messageLog,L=i.player}break}}}else if(V===_.GameState.PLAYER_TURN)if("move"===t.type){let e=null;{const i=A.filter(e=>e.x===L.x+t.dir[0]&&e.y===L.y+t.dir[1]);i.length>0&&(e=i[0])}e&&(i=i.concat(L.fighter.attack(e))),I[C].isBlocked(L.x+t.dir[0],L.y+t.dir[1])||e&&e.isBlocking||(L.x+=t.dir[0],L.y+=t.dir[1]),V=_.GameState.ENEMY_TURN}else if("pickup"===t.type){const t=A.filter(t=>(t.item||t.equippable)&&t.x===L.x&&t.y===L.y);t.length>0?i=i.concat(L.inventory.addItem(t[0])):P.addMessage(new y.Message("There is nothing here to pick up.","yellow")),V=_.GameState.ENEMY_TURN}else if("open-character-panel"===t.type)H=V,V=_.GameState.SHOW_CHARACTER_PANEL;else if("open-inventory"===t.type)H=V,k=0,V=_.GameState.SHOW_INVENTORY;else if("exit"===t.type)S.saveGame(L,A,I,C,P,V),k=0,V=_.GameState.MAIN_MENU,A=[],I=[];else if("enter"===t.type){const t=A.filter(t=>t.stairs&&t.x===L.x&&t.y===L.y);t.length>0&&([A,C]=h.enterStairs(t[0].stairs,L,I,P,new M.TutorialMapGenerator,C+1))}else"wait"===t.type&&(P.addMessage(new y.Message("You wait for a moment.","white")),V=_.GameState.ENEMY_TURN);else V===_.GameState.PLAYER_DEAD?"open-inventory"===t.type&&(H=V,k=0,V=_.GameState.SHOW_INVENTORY):V===_.GameState.SHOW_CHARACTER_PANEL?"exit"===t.type&&(V=H):V===_.GameState.SHOW_INVENTORY?"exit"===t.type?V=H:"move"===t.type?(k+=t.dir[1])<0?k=0:k>=L.inventory.items.length&&(k=L.inventory.items.length-1):"enter"===t.type?(i=i.concat(L.inventory.useItem(k,A,x)),k>=L.inventory.items.length&&(k=L.inventory.items.length-1)):"drop"===t.type&&(i=i.concat(L.inventory.dropItem(k,A)),k>=L.inventory.items.length&&(k=L.inventory.items.length-1)):V===_.GameState.TARGETING&&("move"===t.type?I[C].getTile(R[0]+t.dir[0],R[1]+t.dir[1]).blocksSight||(R[0]+=t.dir[0],R[1]+=t.dir[1]):"enter"===t.type?(i=i.concat(L.inventory.useItem(k,A,x,R[0],R[1])),k>=L.inventory.items.length&&(k=L.inventory.items.length-1),V=H):"exit"===t.type&&(V=H));G(i),U(b,O,L),function(){if(V!==_.GameState.ENEMY_TURN)return;let t=[];for(const e of A)e.ai&&(t=t.concat(e.ai.takeTurn(L,x,I[C],A)));V=_.GameState.PLAYER_TURN,G(t),U(b,O,L)}()}e.main=function(){if(!o.isSupported())throw new Error("ERROR: ROT.js is not supported by this browser!");const t=document.getElementById("app");b=new o.Display({fontSize:20,forceSquareRatio:!0,height:e.CONSTANTS.SCREEN_HEIGHT,width:e.CONSTANTS.SCREEN_WIDTH}),t.appendChild(b.getContainer()),O=new o.Display({fontSize:20,forceSquareRatio:!0,height:e.CONSTANTS.PANEL_HEIGHT,width:e.CONSTANTS.SCREEN_WIDTH}),t.appendChild(O.getContainer()),K(b,O),window.onkeydown=W,window.onmousemove=Y,window.onresize=(()=>{K(b,O),U(b,O,L)}),document.getElementById("touch-icons").ontouchstart=(t=>t.stopPropagation()),window.ontouchstart=B,window.ontouchend=(t=>{t.preventDefault(),N&&(window.clearInterval(N),N=null)}),U(b,O,L)}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(10);e.Entity=class{constructor(t,e,i,o,n,r,s,a,h=null,l=null,c=null,u=null,p=null,_=null,d=null,f=null){this.id=t,this.x=e,this.y=i,this.color=o,this.symbol=n,this.isBlocking=r,this.name=s,this.renderOrder=a,this.fighter=h,this.ai=l,this.item=c,this.inventory=u,this.stairs=p,this.level=_,this.equipment=d,this.equippable=f,this.fighter&&(this.fighter.owner=this),this.ai&&(this.ai.owner=this),this.item&&(this.item.owner=this),this.inventory&&(this.inventory.owner=this),this.stairs&&(this.stairs.owner=this),this.level&&(this.level.owner=this),this.equipment&&(this.equipment.owner=this),this.equippable&&(this.equippable.owner=this)}distanceTo(t){return this.distanceToPos(t.x,t.y)}distanceToPos(t,e){const i=t-this.x,o=e-this.y;return Math.sqrt(i*i+o*o)}move(t,e){this.x+=t,this.y+=e}moveAstar(t,e,i){let n=!1;new o.Path.AStar(t.x,t.y,(t,o)=>!e.isBlocked(t,o)&&!i.some(e=>e.x===t&&e.y===o)).compute(this.x,this.y,(t,e)=>{n||(n=!0,this.x=t,this.y=e)}),n||this.moveTowards(t.x,t.y,e,i)}moveTowards(t,e,i,o){let n=t-this.x,r=e-this.y;const s=Math.sqrt(n*n+r*r);n=Math.round(n/s),r=Math.round(r/s),i.isBlocked(this.x+n,this.y+r)||o.some(t=>t.x===this.x+n&&t.y===this.y+r)||this.move(n,r)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.STAIRS=0]="STAIRS",t[t.CORPSE=1]="CORPSE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR"}(e.RenderOrder||(e.RenderOrder={}))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(2);e.Equipment=class{constructor(){this.equipped=new Array(o.EquipmentSlot.COUNT)}static getMaxHpBonus(t){return t.equipped.reduce((t,e)=>t+(e?e.maxHpBonus:0),0)}static getPowerBonus(t){return t.equipped.reduce((t,e)=>t+(e?e.powerBonus:0),0)}static getDefenseBonus(t){return t.equipped.reduce((t,e)=>t+(e?e.defenseBonus:0),0)}static toggleEquip(t,e){const i=[];return t.equipped[e.slot]===e?(t.equipped[e.slot]=null,i.push({dequipped:e.owner})):(t.equipped[e.slot]&&i.push({dequipped:t.equipped[e.slot].owner}),t.equipped[e.slot]=e,i.push({equipped:e.owner})),i}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Equipment",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.randomInt=function(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.PLAYER_TURN=0]="PLAYER_TURN",t[t.ENEMY_TURN=1]="ENEMY_TURN",t[t.PLAYER_DEAD=2]="PLAYER_DEAD",t[t.SHOW_INVENTORY=3]="SHOW_INVENTORY",t[t.TARGETING=4]="TARGETING",t[t.MAIN_MENU=5]="MAIN_MENU",t[t.LEVEL_UP=6]="LEVEL_UP",t[t.SHOW_CHARACTER_PANEL=7]="SHOW_CHARACTER_PANEL"}(e.GameState||(e.GameState={}))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class o{constructor(t=1,e=0,i=200,o=150){this.currentLevel=t,this.currentXp=e,this.levelUpBase=i,this.levelUpFactor=o}static addXp(t,e){return t.currentXp+=e,t.currentXp>o.xpToLevel(t)&&(t.currentXp-=o.xpToLevel(t),t.currentLevel++,!0)}static xpToLevel(t){return t.levelUpBase+t.levelUpFactor*t.currentLevel}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Level",t}}e.Level=o},function(t,e,i){(function(i,o){var n,r,s;i.requestAnimationFrame=function(t){return setTimeout(function(){t(Date.now())},1e3/60)},i.document={body:{appendChild:function(t){},scrollLeft:0,scrollTop:0},createElement:function(t){var e;return e={getBoundingClientRect:function(){return{left:0,top:0}},getContext:function(t){return{_termcolor:null,beginPath:function(){},canvas:e,clearRect:function(t,e,i,n){if(null!==this._termcolor){var r=this._termcolor.clearToAnsi(this.fillStyle);o.stdout.write(r)}},drawImage:function(t,e,i,o,n,r,s,a,h){},fill:function(){},fillRect:function(t,e,i,n){if(null!==this._termcolor){var r=this._termcolor.clearToAnsi(this.fillStyle);o.stdout.write(r)}},fillStyle:"#000",fillText:function(t,e,i){},font:"monospace",lineTo:function(t,e){},measureText:function(t){return{width:12}},moveTo:function(t,e){},textAlign:"center",textBaseline:"middle"}},height:0,style:{left:"100px",position:"absolute",top:"100px",visibility:"hidden"},width:0}},documentElement:{scrollLeft:0,scrollTop:0}},r=[],void 0===(s="function"==typeof(n=function(){var t={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};for(var i in t.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(t,e){for(var i={width:0,height:1},o=this.tokenize(t,e),n=0,r=0;r<o.length;r++){var s=o[r];switch(s.type){case this.TYPE_TEXT:n+=s.value.length;break;case this.TYPE_NEWLINE:i.height++,i.width=Math.max(i.width,n),n=0}}return i.width=Math.max(i.width,n),i},tokenize:function(e,i){var o=[],n=0;e.replace(this.RE_COLORS,function(i,r,s,a){var h=e.substring(n,a);return h.length&&o.push({type:t.Text.TYPE_TEXT,value:h}),o.push({type:"c"==r?t.Text.TYPE_FG:t.Text.TYPE_BG,value:s.trim()}),n=a+i.length,""});var r=e.substring(n);return r.length&&o.push({type:t.Text.TYPE_TEXT,value:r}),this._breakLines(o,i)},_breakLines:function(e,i){i||(i=1/0);for(var o=0,n=0,r=-1;o<e.length;)if((u=e[o]).type==t.Text.TYPE_NEWLINE&&(n=0,r=-1),u.type==t.Text.TYPE_TEXT){for(;0==n&&" "==u.value.charAt(0);)u.value=u.value.substring(1);if(-1!=(a=u.value.indexOf("\n"))){u.value=this._breakInsideToken(e,o,a,!0);for(var s=u.value.split("");s.length&&" "==s[s.length-1];)s.pop();u.value=s.join("")}if(u.value.length){if(n+u.value.length>i){for(var a=-1;;){var h=u.value.indexOf(" ",a+1);if(-1==h)break;if(n+h>i)break;a=h}if(-1!=a)u.value=this._breakInsideToken(e,o,a,!0);else if(-1!=r){var l=(u=e[r]).value.lastIndexOf(" ");u.value=this._breakInsideToken(e,r,l,!0),o=r}else u.value=this._breakInsideToken(e,o,i-n,!1)}else n+=u.value.length,-1!=u.value.indexOf(" ")&&(r=o);o++}else e.splice(o,1)}else o++;e.push({type:t.Text.TYPE_NEWLINE});var c=null;for(o=0;o<e.length;o++){var u;switch((u=e[o]).type){case t.Text.TYPE_TEXT:c=u;break;case t.Text.TYPE_NEWLINE:if(c){for(s=c.value.split("");s.length&&" "==s[s.length-1];)s.pop();c.value=s.join("")}c=null}}return e.pop(),e},_breakInsideToken:function(e,i,o,n){var r={type:t.Text.TYPE_NEWLINE},s={type:t.Text.TYPE_TEXT,value:e[i].value.substring(o+(n?1:0))};return e.splice(i+1,0,r,s),e[i].value.substring(0,o)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(t.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var t=[],e=this.slice();e.length;){var i=e.indexOf(e.random());t.push(e.splice(i,1)[0])}return t},Number.prototype.mod=Number.prototype.mod||function(t){return(this%t+t)%t},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(t,e){for(var i=t||"0",o=e||2,n="";n.length<o-this.length;)n+=i;return(n=n.substring(0,o-this.length))+this},String.prototype.rpad=String.prototype.rpad||function(t,e){for(var i=t||"0",o=e||2,n="";n.length<o-this.length;)n+=i;return this+(n=n.substring(0,o-this.length))},String.format=String.format||function(t){var e=String.format.map,i=Array.prototype.slice.call(arguments,1);return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(o,n,r,s){if("%"==t.charAt(s-1))return o.substring(1);if(!i.length)return o;var a=i[0],h=(n||r).split(","),l=h.shift(),c=e[l.toLowerCase()];if(!c)return o;var u=(a=i.shift())[c].apply(a,h),p=l.charAt(0);return p!=p.toLowerCase()&&(u=u.capitalize()),u})},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),String.format.apply(String,t)},Object.create||(Object.create=function(t){var e=function(){};return e.prototype=t,new e}),Function.prototype.extend=Function.prototype.extend||function(t){return this.prototype=Object.create(t.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(function(){t(Date.now())},1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){return clearTimeout(t)}),t.Display=function(e){var i=document.createElement("canvas");this._context=i.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var o={width:t.DEFAULT_WIDTH,height:t.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var n in e)o[n]=e[n];this.setOptions(o),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},t.Display.prototype.DEBUG=function(t,e,i){var o=[this._options.bg,this._options.fg];this.draw(t,e,null,null,o[i%o.length])},t.Display.prototype.clear=function(){this._data={},this._dirty=!0},t.Display.prototype.setOptions=function(e){for(var i in e)this._options[i]=e[i];if(e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){e.layout&&(this._backend=new(t.Display[e.layout.capitalize()])(this._context));var o=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=o,this._backend.compute(this._options),this._context.font=o,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},t.Display.prototype.getOptions=function(){return this._options},t.Display.prototype.getContainer=function(){return this._context.canvas},t.Display.prototype.computeSize=function(t,e){return this._backend.computeSize(t,e,this._options)},t.Display.prototype.computeFontSize=function(t,e){return this._backend.computeFontSize(t,e,this._options)},t.Display.prototype.eventToPosition=function(t){if(t.touches)var e=t.touches[0].clientX,i=t.touches[0].clientY;else e=t.clientX,i=t.clientY;var o=this._context.canvas.getBoundingClientRect();return e-=o.left,i-=o.top,e*=this._context.canvas.width/this._context.canvas.clientWidth,i*=this._context.canvas.height/this._context.canvas.clientHeight,e<0||i<0||e>=this._context.canvas.width||i>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(e,i)},t.Display.prototype.draw=function(t,e,i,o,n){o||(o=this._options.fg),n||(n=this._options.bg),this._data[t+","+e]=[t,e,i,o,n],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[t+","+e]=!0)},t.Display.prototype.drawText=function(e,i,o,n){var r=null,s=null,a=e,h=i,l=1;n||(n=this._options.width-e);for(var c=t.Text.tokenize(o,n);c.length;){var u=c.shift();switch(u.type){case t.Text.TYPE_TEXT:for(var p=!1,_=!1,d=!1,f=!1,g=0;g<u.value.length;g++){var m=u.value.charCodeAt(g),y=u.value.charAt(g);d=m>65280&&m<65377||m>65500&&m<65512||m>65518,p=32==y.charCodeAt(0)||12288==y.charCodeAt(0),!f||d||p||a++,d&&!_&&a++,this.draw(a++,h,y,r,s),_=p,f=d}break;case t.Text.TYPE_FG:r=u.value||null;break;case t.Text.TYPE_BG:s=u.value||null;break;case t.Text.TYPE_NEWLINE:a=e,h++,l++}}return l},t.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(!0===this._dirty)for(var t in this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height),this._data)this._draw(t,!1);else for(var e in this._dirty)this._draw(e,!0);this._dirty=!1}},t.Display.prototype._draw=function(t,e){var i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)},t.Display.Backend=function(t){this._context=t},t.Display.Backend.prototype.compute=function(t){},t.Display.Backend.prototype.draw=function(t,e){},t.Display.Backend.prototype.computeSize=function(t,e){},t.Display.Backend.prototype.computeFontSize=function(t,e){},t.Display.Backend.prototype.eventToPosition=function(t,e){},t.Display.Rect=function(e){t.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},t.Display.Rect.extend(t.Display.Backend),t.Display.Rect.cache=!1,t.Display.Rect.prototype.compute=function(t){this._canvasCache={},this._options=t;var e=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=t.width*this._spacingX,this._context.canvas.height=t.height*this._spacingY},t.Display.Rect.prototype.draw=function(t,e){this.constructor.cache?this._drawWithCache(t,e):this._drawNoCache(t,e)},t.Display.Rect.prototype._drawWithCache=function(t,e){var i=t[0],o=t[1],n=t[2],r=t[3],s=t[4],a=""+n+r+s;if(a in this._canvasCache)var h=this._canvasCache[a];else{var l=this._options.border,c=(h=document.createElement("canvas")).getContext("2d");if(h.width=this._spacingX,h.height=this._spacingY,c.fillStyle=s,c.fillRect(l,l,h.width-l,h.height-l),n){c.fillStyle=r,c.font=this._context.font,c.textAlign="center",c.textBaseline="middle";for(var u=[].concat(n),p=0;p<u.length;p++)c.fillText(u[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=h}this._context.drawImage(h,i*this._spacingX,o*this._spacingY)},t.Display.Rect.prototype._drawNoCache=function(t,e){var i=t[0],o=t[1],n=t[2],r=t[3],s=t[4];if(e){var a=this._options.border;this._context.fillStyle=s,this._context.fillRect(i*this._spacingX+a,o*this._spacingY+a,this._spacingX-a,this._spacingY-a)}if(n){this._context.fillStyle=r;for(var h=[].concat(n),l=0;l<h.length;l++)this._context.fillText(h[l],(i+.5)*this._spacingX,Math.ceil((o+.5)*this._spacingY))}},t.Display.Rect.prototype.computeSize=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},t.Display.Rect.prototype.computeFontSize=function(t,e){var i=Math.floor(t/this._options.width),o=Math.floor(e/this._options.height),n=this._context.font;this._context.font="100px "+this._options.fontFamily;var r=Math.ceil(this._context.measureText("W").width);this._context.font=n;var s=r/100*o/i;return s>1&&(o=Math.floor(o/s)),Math.floor(o/this._options.spacing)},t.Display.Rect.prototype.eventToPosition=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},t.Display.Hex=function(e){t.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},t.Display.Hex.extend(t.Display.Backend),t.Display.Hex.prototype.compute=function(t){this._options=t;var e=Math.ceil(this._context.measureText("W").width);if(this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose)var i="height",o="width";else i="width",o="height";this._context.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._context.canvas[o]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)},t.Display.Hex.prototype.draw=function(t,e){var i=t[0],o=t[1],n=t[2],r=t[3],s=t[4],a=[(i+1)*this._spacingX,o*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._context.fillStyle=s,this._fill(a[0],a[1])),n){this._context.fillStyle=r;for(var h=[].concat(n),l=0;l<h.length;l++)this._context.fillText(h[l],a[0],Math.ceil(a[1]))}},t.Display.Hex.prototype.computeSize=function(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]},t.Display.Hex.prototype.computeFontSize=function(t,e){this._options.transpose&&(t+=e,t-=e=t-e);var i=2*t/((this._options.width+1)*Math.sqrt(3))-1,o=e/(2+1.5*(this._options.height-1)),n=Math.min(i,o),r=this._context.font;this._context.font="100px "+this._options.fontFamily;var s=Math.ceil(this._context.measureText("W").width);this._context.font=r;var a=s/100,h=2*(n=Math.floor(n)+1)/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1},t.Display.Hex.prototype.eventToPosition=function(t,e){if(this._options.transpose){t+=e,t-=e=t-e;var i=this._context.canvas.width}else i=this._context.canvas.height;var o=i/this._options.height;return(e=Math.floor(e/o)).mod(2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]},t.Display.Hex.prototype._fill=function(t,e){var i=this._hexSize,o=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(t-i+o,e),this._context.lineTo(t-i/2+o,e+this._spacingX-o),this._context.lineTo(t+i/2-o,e+this._spacingX-o),this._context.lineTo(t+i-o,e),this._context.lineTo(t+i/2-o,e-this._spacingX+o),this._context.lineTo(t-i/2+o,e-this._spacingX+o),this._context.lineTo(t-i+o,e)):(this._context.moveTo(t,e-i+o),this._context.lineTo(t+this._spacingX-o,e-i/2+o),this._context.lineTo(t+this._spacingX-o,e+i/2-o),this._context.lineTo(t,e+i-o),this._context.lineTo(t-this._spacingX+o,e+i/2-o),this._context.lineTo(t-this._spacingX+o,e-i/2+o),this._context.lineTo(t,e-i+o)),this._context.fill()},t.Display.Tile=function(e){t.Display.Rect.call(this,e),this._options={},this._colorCanvas=document.createElement("canvas")},t.Display.Tile.extend(t.Display.Rect),t.Display.Tile.prototype.compute=function(t){this._options=t,this._context.canvas.width=t.width*t.tileWidth,this._context.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight},t.Display.Tile.prototype.draw=function(t,e){var i=t[0],o=t[1],n=t[2],r=t[3],s=t[4],a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._context.clearRect(i*a,o*h,a,h):(this._context.fillStyle=s,this._context.fillRect(i*a,o*h,a,h))),n)for(var l=[].concat(n),c=0;c<l.length;c++){var u=this._options.tileMap[l[c]];if(!u)throw new Error("Char '"+l[c]+"' not found in tileMap");if(this._options.tileColorize){var p=this._colorCanvas,_=p.getContext("2d");_.clearRect(0,0,a,h),_.drawImage(this._options.tileSet,u[0],u[1],a,h,0,0,a,h),"transparent"!=r&&(_.fillStyle=r,_.globalCompositeOperation="source-atop",_.fillRect(0,0,a,h)),"transparent"!=s&&(_.fillStyle=s,_.globalCompositeOperation="destination-over",_.fillRect(0,0,a,h)),this._context.drawImage(p,i*a,o*h,a,h)}else this._context.drawImage(this._options.tileSet,u[0],u[1],a,h,i*a,o*h,a,h)}},t.Display.Tile.prototype.computeSize=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},t.Display.Tile.prototype.computeFontSize=function(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]},t.Display.Tile.prototype.eventToPosition=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},t.RNG={getSeed:function(){return this._seed},setSeed:function(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*this._frac,t=69069*t+1>>>0,this._s1=t*this._frac,t=69069*t+1>>>0,this._s2=t*this._frac,this._c=1,this},getUniform:function(){var t=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2},getUniformInt:function(t,e){var i=Math.max(t,e),o=Math.min(t,e);return Math.floor(this.getUniform()*(i-o+1))+o},getNormal:function(t,e){do{var i=2*this.getUniform()-1,o=2*this.getUniform()-1,n=i*i+o*o}while(n>1||0==n);var r=i*Math.sqrt(-2*Math.log(n)/n);return(t||0)+r*(e||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(t){var e=0;for(var i in t)e+=t[i];var o=this.getUniform()*e,n=0;for(var i in t)if(o<(n+=t[i]))return i;return i},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this},clone:function(){var t=Object.create(this);return t.setState(this.getState()),t},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},t.RNG.setSeed(Date.now()),t.StringGenerator=function(t){for(var e in this._options={words:!1,order:3,prior:.001},t)this._options[e]=t[e];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var i=0;i<this._options.order;i++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},t.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},t.StringGenerator.prototype.generate=function(){for(var t=[this._sample(this._prefix)];t[t.length-1]!=this._boundary;)t.push(this._sample(t));return this._join(t.slice(0,-1))},t.StringGenerator.prototype.observe=function(t){for(var e=this._split(t),i=0;i<e.length;i++)this._priorValues[e[i]]=this._options.prior;for(e=this._prefix.concat(e).concat(this._suffix),i=this._options.order;i<e.length;i++)for(var o=e.slice(i-this._options.order,i),n=e[i],r=0;r<o.length;r++){var s=o.slice(r);this._observeEvent(s,n)}},t.StringGenerator.prototype.getStats=function(){var t=[],e=0;for(var i in this._priorValues)e++;e--,t.push("distinct samples: "+e);var o=0,n=0;for(var i in this._data)for(var r in o++,this._data[i])n++;return t.push("dictionary size (contexts): "+o),t.push("dictionary size (events): "+n),t.join(", ")},t.StringGenerator.prototype._split=function(t){return t.split(this._options.words?/\s+/:"")},t.StringGenerator.prototype._join=function(t){return t.join(this._options.words?" ":"")},t.StringGenerator.prototype._observeEvent=function(t,e){var i=this._join(t);i in this._data||(this._data[i]={});var o=this._data[i];e in o||(o[e]=0),o[e]++},t.StringGenerator.prototype._sample=function(e){e=this._backoff(e);var i=this._join(e),o=this._data[i],n={};if(this._options.prior){for(var r in this._priorValues)n[r]=this._priorValues[r];for(var r in o)n[r]+=o[r]}else n=o;return t.RNG.getWeightedValue(n)},t.StringGenerator.prototype._backoff=function(t){for(t.length>this._options.order?t=t.slice(-this._options.order):t.length<this._options.order&&(t=this._prefix.slice(0,this._options.order-t.length).concat(t));!(this._join(t)in this._data)&&t.length>0;)t=t.slice(1);return t},t.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},t.EventQueue.prototype.getTime=function(){return this._time},t.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this},t.EventQueue.prototype.add=function(t,e){for(var i=this._events.length,o=0;o<this._eventTimes.length;o++)if(this._eventTimes[o]>e){i=o;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)},t.EventQueue.prototype.get=function(){if(!this._events.length)return null;var t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(var e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]},t.EventQueue.prototype.getEventTime=function(t){var e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]},t.EventQueue.prototype.remove=function(t){var e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)},t.EventQueue.prototype._remove=function(t){this._events.splice(t,1),this._eventTimes.splice(t,1)},t.Scheduler=function(){this._queue=new t.EventQueue,this._repeat=[],this._current=null},t.Scheduler.prototype.getTime=function(){return this._queue.getTime()},t.Scheduler.prototype.add=function(t,e){return e&&this._repeat.push(t),this},t.Scheduler.prototype.getTimeOf=function(t){return this._queue.getEventTime(t)},t.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},t.Scheduler.prototype.remove=function(t){var e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e},t.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},t.Scheduler.Simple=function(){t.Scheduler.call(this)},t.Scheduler.Simple.extend(t.Scheduler),t.Scheduler.Simple.prototype.add=function(e,i){return this._queue.add(e,0),t.Scheduler.prototype.add.call(this,e,i)},t.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),t.Scheduler.prototype.next.call(this)},t.Scheduler.Speed=function(){t.Scheduler.call(this)},t.Scheduler.Speed.extend(t.Scheduler),t.Scheduler.Speed.prototype.add=function(e,i,o){return this._queue.add(e,void 0!==o?o:1/e.getSpeed()),t.Scheduler.prototype.add.call(this,e,i)},t.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),t.Scheduler.prototype.next.call(this)},t.Scheduler.Action=function(){t.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},t.Scheduler.Action.extend(t.Scheduler),t.Scheduler.Action.prototype.add=function(e,i,o){return this._queue.add(e,o||this._defaultDuration),t.Scheduler.prototype.add.call(this,e,i)},t.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,t.Scheduler.prototype.clear.call(this)},t.Scheduler.Action.prototype.remove=function(e){return e==this._current&&(this._duration=this._defaultDuration),t.Scheduler.prototype.remove.call(this,e)},t.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),t.Scheduler.prototype.next.call(this)},t.Scheduler.Action.prototype.setDuration=function(t){return this._current&&(this._duration=t),this},t.Engine=function(t){this._scheduler=t,this._lock=1},t.Engine.prototype.start=function(){return this.unlock()},t.Engine.prototype.lock=function(){return this._lock++,this},t.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var t=this._scheduler.next();if(!t)return this.lock();var e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this},t.Map=function(e,i){this._width=e||t.DEFAULT_WIDTH,this._height=i||t.DEFAULT_HEIGHT},t.Map.prototype.create=function(t){},t.Map.prototype._fillMap=function(t){for(var e=[],i=0;i<this._width;i++){e.push([]);for(var o=0;o<this._height;o++)e[i].push(t)}return e},t.Map.Arena=function(e,i){t.Map.call(this,e,i)},t.Map.Arena.extend(t.Map),t.Map.Arena.prototype.create=function(t){for(var e=this._width-1,i=this._height-1,o=0;o<=e;o++)for(var n=0;n<=i;n++)t(o,n,o&&n&&o<e&&n<i?0:1);return this},t.Map.DividedMaze=function(e,i){t.Map.call(this,e,i),this._stack=[]},t.Map.DividedMaze.extend(t.Map),t.Map.DividedMaze.prototype.create=function(t){var e=this._width,i=this._height;this._map=[];for(var o=0;o<e;o++){this._map.push([]);for(var n=0;n<i;n++){var r=0==o||0==n||o+1==e||n+1==i;this._map[o].push(r?1:0)}}for(this._stack=[[1,1,e-2,i-2]],this._process(),o=0;o<e;o++)for(n=0;n<i;n++)t(o,n,this._map[o][n]);return this._map=null,this},t.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var t=this._stack.shift();this._partitionRoom(t)}},t.Map.DividedMaze.prototype._partitionRoom=function(t){for(var e=[],i=[],o=t[0]+1;o<t[2];o++){var n=this._map[o][t[1]-1],r=this._map[o][t[3]+1];!n||!r||o%2||e.push(o)}for(var s=t[1]+1;s<t[3];s++){var a=this._map[t[0]-1][s],h=this._map[t[2]+1][s];!a||!h||s%2||i.push(s)}if(e.length&&i.length){var l=e.random(),c=i.random();this._map[l][c]=1;var u=[],p=[];for(u.push(p),o=t[0];o<l;o++)this._map[o][c]=1,p.push([o,c]);for(p=[],u.push(p),o=l+1;o<=t[2];o++)this._map[o][c]=1,p.push([o,c]);for(p=[],u.push(p),s=t[1];s<c;s++)this._map[l][s]=1,p.push([l,s]);for(p=[],u.push(p),s=c+1;s<=t[3];s++)this._map[l][s]=1,p.push([l,s]);var _=u.random();for(o=0;o<u.length;o++)if((p=u[o])!=_){var d=p.random();this._map[d[0]][d[1]]=0}this._stack.push([t[0],t[1],l-1,c-1]),this._stack.push([l+1,t[1],t[2],c-1]),this._stack.push([t[0],c+1,l-1,t[3]]),this._stack.push([l+1,c+1,t[2],t[3]])}},t.Map.IceyMaze=function(e,i,o){t.Map.call(this,e,i),this._regularity=o||0},t.Map.IceyMaze.extend(t.Map),t.Map.IceyMaze.prototype.create=function(e){var i=this._width,o=this._height,n=this._fillMap(1);i-=i%2?1:2,o-=o%2?1:2;var r=0,s=0,a=0,h=0,l=0,c=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(r=1+2*Math.floor(t.RNG.getUniform()*(i-1)/2),s=1+2*Math.floor(t.RNG.getUniform()*(o-1)/2),l||(n[r][s]=0),!n[r][s]){this._randomize(u);do{0==Math.floor(t.RNG.getUniform()*(this._regularity+1))&&this._randomize(u),c=!0;for(var p=0;p<4;p++)if(a=r+2*u[p][0],h=s+2*u[p][1],this._isFree(n,a,h,i,o)){n[a][h]=0,n[r+u[p][0]][s+u[p][1]]=0,r=a,s=h,c=!1,l++;break}}while(!c)}}while(l+1<i*o/4);for(p=0;p<this._width;p++)for(var _=0;_<this._height;_++)e(p,_,n[p][_]);return this._map=null,this},t.Map.IceyMaze.prototype._randomize=function(e){for(var i=0;i<4;i++)e[i][0]=0,e[i][1]=0;switch(Math.floor(4*t.RNG.getUniform())){case 0:e[0][0]=-1,e[1][0]=1,e[2][1]=-1,e[3][1]=1;break;case 1:e[3][0]=-1,e[2][0]=1,e[1][1]=-1,e[0][1]=1;break;case 2:e[2][0]=-1,e[3][0]=1,e[0][1]=-1,e[1][1]=1;break;case 3:e[1][0]=-1,e[0][0]=1,e[3][1]=-1,e[2][1]=1}},t.Map.IceyMaze.prototype._isFree=function(t,e,i,o,n){return!(e<1||i<1||e>=o||i>=n)&&t[e][i]},t.Map.EllerMaze=function(e,i){t.Map.call(this,e,i)},t.Map.EllerMaze.extend(t.Map),t.Map.EllerMaze.prototype.create=function(e){for(var i=this._fillMap(1),o=Math.ceil((this._width-2)/2),n=[],r=[],s=0;s<o;s++)n.push(s),r.push(s);n.push(o-1);for(var a=1;a+3<this._height;a+=2)for(s=0;s<o;s++){var h=a;i[l=2*s+1][h]=0,s!=n[s+1]&&t.RNG.getUniform()>.375&&(this._addToList(s,n,r),i[l+1][h]=0),s!=n[s]&&t.RNG.getUniform()>.375?this._removeFromList(s,n,r):i[l][h+1]=0}for(s=0;s<o;s++){var l;h=a,i[l=2*s+1][h]=0,s!=n[s+1]&&(s==n[s]||t.RNG.getUniform()>.375)&&(this._addToList(s,n,r),i[l+1][h]=0),this._removeFromList(s,n,r)}for(s=0;s<this._width;s++)for(a=0;a<this._height;a++)e(s,a,i[s][a]);return this},t.Map.EllerMaze.prototype._removeFromList=function(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t},t.Map.EllerMaze.prototype._addToList=function(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t},t.Map.Cellular=function(e,i,o){t.Map.call(this,e,i),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(o),this._dirs=t.DIRS[this._options.topology],this._map=this._fillMap(0)},t.Map.Cellular.extend(t.Map),t.Map.Cellular.prototype.randomize=function(e){for(var i=0;i<this._width;i++)for(var o=0;o<this._height;o++)this._map[i][o]=t.RNG.getUniform()<e?1:0;return this},t.Map.Cellular.prototype.setOptions=function(t){for(var e in t)this._options[e]=t[e]},t.Map.Cellular.prototype.set=function(t,e,i){this._map[t][e]=i},t.Map.Cellular.prototype.create=function(t){for(var e=this._fillMap(0),i=this._options.born,o=this._options.survive,n=0;n<this._height;n++){var r=1,s=0;6==this._options.topology&&(r=2,s=n%2);for(var a=s;a<this._width;a+=r){var h=this._map[a][n],l=this._getNeighbors(a,n);h&&-1!=o.indexOf(l)?e[a][n]=1:h||-1==i.indexOf(l)||(e[a][n]=1)}}this._map=e,t&&this._serviceCallback(t)},t.Map.Cellular.prototype._serviceCallback=function(t){for(var e=0;e<this._height;e++){var i=1,o=0;6==this._options.topology&&(i=2,o=e%2);for(var n=o;n<this._width;n+=i)t(n,e,this._map[n][e])}},t.Map.Cellular.prototype._getNeighbors=function(t,e){for(var i=0,o=0;o<this._dirs.length;o++){var n=this._dirs[o],r=t+n[0],s=e+n[1];r<0||r>=this._width||s<0||s>=this._height||(i+=1==this._map[r][s]?1:0)}return i},t.Map.Cellular.prototype.connect=function(e,i,o){i||(i=0);var n=[],r={},s=1,a=[0,0];6==this._options.topology&&(s=2,a=[0,1]);for(var h=0;h<this._height;h++)for(var l=a[h%2];l<this._width;l+=s)if(this._freeSpace(l,h,i)){var c=[l,h];r[this._pointKey(c)]=c,n.push([l,h])}var u=n[t.RNG.getUniformInt(0,n.length-1)],p=this._pointKey(u),_={};for(_[p]=u,delete r[p],this._findConnected(_,r,[u],!1,i);Object.keys(r).length>0;){var d=(c=this._getFromTo(_,r))[0],f=c[1],g={};g[this._pointKey(d)]=d,this._findConnected(g,r,[d],!0,i);var m=6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected;for(var y in m.call(this,f,d,_,r,i,o),g){var v=g[y];this._map[v[0]][v[1]]=i,_[y]=v,delete r[y]}}e&&this._serviceCallback(e)},t.Map.Cellular.prototype._getFromTo=function(e,i){for(var o,n,r=Object.keys(e),s=Object.keys(i),a=0;a<5;a++){var h;if(r.length<s.length?(n=e[(h=r)[t.RNG.getUniformInt(0,h.length-1)]],o=this._getClosest(n,i)):(o=i[(h=s)[t.RNG.getUniformInt(0,h.length-1)]],n=this._getClosest(o,e)),(o[0]-n[0])*(o[0]-n[0])+(o[1]-n[1])*(o[1]-n[1])<64)break}return[o,n]},t.Map.Cellular.prototype._getClosest=function(t,e){var i=null,o=null;for(k in e){var n=e[k],r=(n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1]);(null==o||r<o)&&(o=r,i=n)}return i},t.Map.Cellular.prototype._findConnected=function(t,e,i,o,n){for(;i.length>0;){var r,s=i.splice(0,1)[0];r=6==this._options.topology?[[s[0]+2,s[1]],[s[0]+1,s[1]-1],[s[0]-1,s[1]-1],[s[0]-2,s[1]],[s[0]-1,s[1]+1],[s[0]+1,s[1]+1]]:[[s[0]+1,s[1]],[s[0]-1,s[1]],[s[0],s[1]+1],[s[0],s[1]-1]];for(var a=0;a<r.length;a++){var h=this._pointKey(r[a]);null==t[h]&&this._freeSpace(r[a][0],r[a][1],n)&&(t[h]=r[a],o||delete e[h],i.push(r[a]))}}},t.Map.Cellular.prototype._tunnelToConnected=function(t,e,i,o,n,r){var s,a;this._pointKey(e),e[0]<t[0]?(s=e,a=t):(s=t,a=e);for(var h=s[0];h<=a[0];h++){this._map[h][s[1]]=n;var l=[h,s[1]];i[p=this._pointKey(l)]=l,delete o[p]}r&&s[0]<a[0]&&r(s,[a[0],s[1]]);var c=a[0];e[1]<t[1]?(s=e,a=t):(s=t,a=e);for(var u=s[1];u<a[1];u++){var p;this._map[c][u]=n,l=[c,u],i[p=this._pointKey(l)]=l,delete o[p]}r&&s[1]<a[1]&&r([a[0],s[1]],[a[0],a[1]])},t.Map.Cellular.prototype._tunnelToConnected6=function(t,e,i,o,n,r){var s,a;e[0]<t[0]?(s=e,a=t):(s=t,a=e);for(var h=s[0],l=s[1];h!=a[0]||l!=a[1];){var c=2;l<a[1]?(l++,c=1):l>a[1]&&(l--,c=1),h<a[0]?h+=c:h>a[0]?h-=c:a[1]%2?h-=c:h+=c,this._map[h][l]=n;var u=[h,l],p=this._pointKey(u);i[p]=u,delete o[p]}r&&r(e,t)},t.Map.Cellular.prototype._freeSpace=function(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i},t.Map.Cellular.prototype._pointKey=function(t){return t[0]+"."+t[1]},t.Map.Dungeon=function(e,i){t.Map.call(this,e,i),this._rooms=[],this._corridors=[]},t.Map.Dungeon.extend(t.Map),t.Map.Dungeon.prototype.getRooms=function(){return this._rooms},t.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},t.Map.Digger=function(e,i,o){for(var n in t.Map.Dungeon.call(this,e,i),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},o)this._options[n]=o[n];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},t.Map.Digger.extend(t.Map.Dungeon),t.Map.Digger.prototype.create=function(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var e=(this._width-2)*(this._height-2);this._firstRoom();var i=Date.now();do{if(Date.now()-i>this._options.timeLimit)break;var o=this._findWall();if(!o)break;var n=o.split(","),r=parseInt(n[0]),s=parseInt(n[1]),a=this._getDiggingDirection(r,s);if(a){var h=0;do{if(h++,this._tryFeature(r,s,a[0],a[1])){this._removeSurroundingWalls(r,s),this._removeSurroundingWalls(r-a[0],s-a[1]);break}}while(h<this._featureAttempts);var l=0;for(var c in this._walls)this._walls[c]>1&&l++}}while(this._dug/e<this._options.dugPercentage||l);if(this._addDoors(),t)for(var u=0;u<this._width;u++)for(var p=0;p<this._height;p++)t(u,p,this._map[u][p]);return this._walls={},this._map=null,this},t.Map.Digger.prototype._digCallback=function(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1},t.Map.Digger.prototype._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},t.Map.Digger.prototype._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},t.Map.Digger.prototype._priorityWallCallback=function(t,e){this._walls[t+","+e]=2},t.Map.Digger.prototype._firstRoom=function(){var e=Math.floor(this._width/2),i=Math.floor(this._height/2),o=t.Map.Feature.Room.createRandomCenter(e,i,this._options);this._rooms.push(o),o.create(this._digCallback)},t.Map.Digger.prototype._findWall=function(){var t=[],e=[];for(var i in this._walls)2==this._walls[i]?e.push(i):t.push(i);var o=e.length?e:t;return o.length?(i=o.sort().random(),delete this._walls[i],i):null},t.Map.Digger.prototype._tryFeature=function(e,i,o,n){var r=t.RNG.getWeightedValue(this._features);return!!(r=t.Map.Feature[r].createRandomAt(e,i,o,n,this._options)).isValid(this._isWallCallback,this._canBeDugCallback)&&(r.create(this._digCallback),r instanceof t.Map.Feature.Room&&this._rooms.push(r),r instanceof t.Map.Feature.Corridor&&(r.createPriorityWalls(this._priorityWallCallback),this._corridors.push(r)),!0)},t.Map.Digger.prototype._removeSurroundingWalls=function(e,i){for(var o=t.DIRS[4],n=0;n<o.length;n++){var r=o[n],s=e+r[0],a=i+r[1];delete this._walls[s+","+a],s=e+2*r[0],a=i+2*r[1],delete this._walls[s+","+a]}},t.Map.Digger.prototype._getDiggingDirection=function(e,i){if(e<=0||i<=0||e>=this._width-1||i>=this._height-1)return null;for(var o=null,n=t.DIRS[4],r=0;r<n.length;r++){var s=n[r],a=e+s[0],h=i+s[1];if(!this._map[a][h]){if(o)return null;o=s}}return o?[-o[0],-o[1]]:null},t.Map.Digger.prototype._addDoors=function(){for(var t=this._map,e=function(e,i){return 1==t[e][i]},i=0;i<this._rooms.length;i++){var o=this._rooms[i];o.clearDoors(),o.addDoors(e)}},t.Map.Uniform=function(e,i,o){for(var n in t.Map.Dungeon.call(this,e,i),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},o)this._options[n]=o[n];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},t.Map.Uniform.extend(t.Map.Dungeon),t.Map.Uniform.prototype.create=function(t){for(var e=Date.now();;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(var i=0;i<this._width;i++)for(var o=0;o<this._height;o++)t(i,o,this._map[i][o]);return this},t.Map.Uniform.prototype._generateRooms=function(){var t=this._width-2,e=this._height-2;do{var i=this._generateRoom();if(this._dug/(t*e)>this._options.roomDugPercentage)break}while(i)},t.Map.Uniform.prototype._generateRoom=function(){for(var e=0;e<this._roomAttempts;){e++;var i=t.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(i.isValid(this._isWallCallback,this._canBeDugCallback))return i.create(this._digCallback),this._rooms.push(i),i}return null},t.Map.Uniform.prototype._generateCorridors=function(){for(var t=0;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(var e=0;e<this._rooms.length;e++){var i=this._rooms[e];i.clearDoors(),i.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var o=this._connected.random(),n=this._closestRoom(this._unconnected,o),r=this._closestRoom(this._connected,n);if(!this._connectRooms(n,r))break;if(!this._unconnected.length)return!0}}return!1},t.Map.Uniform.prototype._closestRoom=function(t,e){for(var i=1/0,o=e.getCenter(),n=null,r=0;r<t.length;r++){var s=t[r],a=s.getCenter(),h=a[0]-o[0],l=a[1]-o[1],c=h*h+l*l;c<i&&(i=c,n=s)}return n},t.Map.Uniform.prototype._connectRooms=function(t,e){var i,o=t.getCenter(),n=e.getCenter(),r=n[0]-o[0],s=n[1]-o[1];if(Math.abs(r)<Math.abs(s))var a=(2+(i=s>0?2:0))%4,h=e.getLeft(),l=e.getRight(),c=0;else a=(2+(i=r>0?1:3))%4,h=e.getTop(),l=e.getBottom(),c=1;var u=this._placeInWall(t,i);if(!u)return!1;if(u[c]>=h&&u[c]<=l){var p=u.slice(),_=null;switch(a){case 0:_=e.getTop()-1;break;case 1:_=e.getRight()+1;break;case 2:_=e.getBottom()+1;break;case 3:_=e.getLeft()-1}p[(c+1)%2]=_,this._digLine([u,p])}else if(u[c]<h-1||u[c]>l+1){var d=u[c]-n[c];switch(a){case 0:case 1:var f=d<0?3:1;break;case 2:case 3:f=d<0?1:3}if(a=(a+f)%4,!(p=this._placeInWall(e,a)))return!1;(m=[0,0])[c]=u[c],m[g=(c+1)%2]=p[g],this._digLine([u,m,p])}else{var g=(c+1)%2;if(!(p=this._placeInWall(e,a)))return!1;var m=Math.round((p[g]+u[g])/2),y=[0,0],v=[0,0];y[c]=u[c],y[g]=m,v[c]=p[c],v[g]=m,this._digLine([u,y,v,p])}return t.addDoor(u[0],u[1]),e.addDoor(p[0],p[1]),-1!=(c=this._unconnected.indexOf(t))&&(this._unconnected.splice(c,1),this._connected.push(t)),-1!=(c=this._unconnected.indexOf(e))&&(this._unconnected.splice(c,1),this._connected.push(e)),!0},t.Map.Uniform.prototype._placeInWall=function(t,e){var i=[0,0],o=[0,0],n=0;switch(e){case 0:o=[1,0],i=[t.getLeft(),t.getTop()-1],n=t.getRight()-t.getLeft()+1;break;case 1:o=[0,1],i=[t.getRight()+1,t.getTop()],n=t.getBottom()-t.getTop()+1;break;case 2:o=[1,0],i=[t.getLeft(),t.getBottom()+1],n=t.getRight()-t.getLeft()+1;break;case 3:o=[0,1],i=[t.getLeft()-1,t.getTop()],n=t.getBottom()-t.getTop()+1}for(var r=[],s=-2,a=0;a<n;a++){var h=i[0]+a*o[0],l=i[1]+a*o[1];r.push(null),1==this._map[h][l]?s!=a-1&&(r[a]=[h,l]):(s=a,a&&(r[a-1]=null))}for(a=r.length-1;a>=0;a--)r[a]||r.splice(a,1);return r.length?r.random():null},t.Map.Uniform.prototype._digLine=function(e){for(var i=1;i<e.length;i++){var o=e[i-1],n=e[i],r=new t.Map.Feature.Corridor(o[0],o[1],n[0],n[1]);r.create(this._digCallback),this._corridors.push(r)}},t.Map.Uniform.prototype._digCallback=function(t,e,i){this._map[t][e]=i,0==i&&this._dug++},t.Map.Uniform.prototype._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},t.Map.Uniform.prototype._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},t.Map.Rogue=function(e,i,o){for(var n in t.Map.call(this,e,i),this._options={cellWidth:3,cellHeight:3},o)this._options[n]=o[n];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},t.Map.Rogue.extend(t.Map),t.Map.Rogue.prototype.create=function(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(var e=0;e<this._width;e++)for(var i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this},t.Map.Rogue.prototype._calculateRoomSize=function(t,e){var i=Math.floor(t/e*.8),o=Math.floor(t/e*.25);return o<2&&(o=2),i<2&&(i=2),[o,i]},t.Map.Rogue.prototype._initRooms=function(){for(var t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(var e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}},t.Map.Rogue.prototype._connectRooms=function(){var e,i,o,n,r,s=t.RNG.getUniformInt(0,this._options.cellWidth-1),a=t.RNG.getUniformInt(0,this._options.cellHeight-1),h=!1;do{var l=[0,2,4,6];l=l.randomize();do{if(h=!1,e=l.pop(),i=s+t.DIRS[8][e][0],o=a+t.DIRS[8][e][1],!(i<0||i>=this._options.cellWidth||o<0||o>=this._options.cellHeight)){if((n=this.rooms[s][a]).connections.length>0&&n.connections[0][0]==i&&n.connections[0][1]==o)break;0==(r=this.rooms[i][o]).connections.length&&(r.connections.push([s,a]),this.connectedCells.push([i,o]),s=i,a=o,h=!0)}}while(l.length>0&&0==h)}while(l.length>0)},t.Map.Rogue.prototype._connectUnconnectedRooms=function(){var e,i,o,n=this._options.cellWidth,r=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var s=0;s<this._options.cellWidth;s++)for(var a=0;a<this._options.cellHeight;a++)if(0==(e=this.rooms[s][a]).connections.length){var h=[0,2,4,6];h=h.randomize(),o=!1;do{var l=h.pop(),c=s+t.DIRS[8][l][0],u=a+t.DIRS[8][l][1];if(!(c<0||c>=n||u<0||u>=r)){if(o=!0,0==(i=this.rooms[c][u]).connections.length)break;for(var p=0;p<i.connections.length;p++)if(i.connections[p][0]==s&&i.connections[p][1]==a){o=!1;break}if(o)break}}while(h.length);o?e.connections.push([i.cellx,i.celly]):console.log("-- Unable to connect room.")}},t.Map.Rogue.prototype._createRandomRoomConnections=function(t){},t.Map.Rogue.prototype._createRooms=function(){for(var e,i,o,n,r,s=this._width,a=this._height,h=this._options.cellWidth,l=this._options.cellHeight,c=Math.floor(this._width/h),u=Math.floor(this._height/l),p=this._options.roomWidth,_=this._options.roomHeight,d=0;d<h;d++)for(var f=0;f<l;f++){if(n=u*f,0==(o=c*d)&&(o=1),0==n&&(n=1),e=t.RNG.getUniformInt(p[0],p[1]),i=t.RNG.getUniformInt(_[0],_[1]),f>0)for(r=this.rooms[d][f-1];n-(r.y+r.height)<3;)n++;if(d>0)for(r=this.rooms[d-1][f];o-(r.x+r.width)<3;)o++;for(var g=Math.round(t.RNG.getUniformInt(0,c-e)/2),m=Math.round(t.RNG.getUniformInt(0,u-i)/2);o+g+e>=s;)g?g--:e--;for(;n+m+i>=a;)m?m--:i--;o+=g,n+=m,this.rooms[d][f].x=o,this.rooms[d][f].y=n,this.rooms[d][f].width=e,this.rooms[d][f].height=i;for(var y=o;y<o+e;y++)for(var v=n;v<n+i;v++)this.map[y][v]=0}},t.Map.Rogue.prototype._getWallPosition=function(e,i){var o,n,r;return 1==i||3==i?(o=t.RNG.getUniformInt(e.x+1,e.x+e.width-2),r=1==i?1+(n=e.y-2):(n=e.y+e.height+1)-1,this.map[o][r]=0):2!=i&&4!=i||(n=t.RNG.getUniformInt(e.y+1,e.y+e.height-2),r=2==i?(o=e.x+e.width+1)-1:1+(o=e.x-2),this.map[r][n]=0),[o,n]},t.Map.Rogue.prototype._drawCorridor=function(e,i){var o,n,r,s,a=i[0]-e[0],h=i[1]-e[1],l=e[0],c=e[1],u=[],p=Math.abs(a),_=Math.abs(h),d=t.RNG.getUniform(),f=d,g=1-d;for(n=a>0?2:6,r=h>0?4:0,p<_?(o=Math.ceil(_*f),u.push([r,o]),u.push([n,p]),o=Math.floor(_*g),u.push([r,o])):(o=Math.ceil(p*f),u.push([n,o]),u.push([r,_]),o=Math.floor(p*g),u.push([n,o])),this.map[l][c]=0;u.length>0;)for(s=u.pop();s[1]>0;)l+=t.DIRS[8][s[0]][0],c+=t.DIRS[8][s[0]][1],this.map[l][c]=0,s[1]=s[1]-1},t.Map.Rogue.prototype._createCorridors=function(){for(var t,e,i,o,n,r=this._options.cellWidth,s=this._options.cellHeight,a=0;a<r;a++)for(var h=0;h<s;h++){t=this.rooms[a][h];for(var l=0;l<t.connections.length;l++)e=t.connections[l],(i=this.rooms[e[0]][e[1]]).cellx>t.cellx?(o=2,n=4):i.cellx<t.cellx?(o=4,n=2):i.celly>t.celly?(o=3,n=1):i.celly<t.celly&&(o=1,n=3),this._drawCorridor(this._getWallPosition(t,o),this._getWallPosition(i,n))}},t.Map.Feature=function(){},t.Map.Feature.prototype.isValid=function(t){},t.Map.Feature.prototype.create=function(t){},t.Map.Feature.prototype.debug=function(){},t.Map.Feature.createRandomAt=function(t,e,i,o,n){},t.Map.Feature.Room=function(t,e,i,o,n,r){this._x1=t,this._y1=e,this._x2=i,this._y2=o,this._doors={},arguments.length>4&&this.addDoor(n,r)},t.Map.Feature.Room.extend(t.Map.Feature),t.Map.Feature.Room.createRandomAt=function(e,i,o,n,r){var s,a,h=r.roomWidth[0],l=r.roomWidth[1],c=t.RNG.getUniformInt(h,l),u=(h=r.roomHeight[0],l=r.roomHeight[1],t.RNG.getUniformInt(h,l));if(1==o)return new this(e+1,s=i-Math.floor(t.RNG.getUniform()*u),e+c,s+u-1,e,i);if(-1==o)return new this(e-c,s=i-Math.floor(t.RNG.getUniform()*u),e-1,s+u-1,e,i);if(1==n)return new this(a=e-Math.floor(t.RNG.getUniform()*c),i+1,a+c-1,i+u,e,i);if(-1==n)return new this(a=e-Math.floor(t.RNG.getUniform()*c),i-u,a+c-1,i-1,e,i);throw new Error("dx or dy must be 1 or -1")},t.Map.Feature.Room.createRandomCenter=function(e,i,o){var n=o.roomWidth[0],r=o.roomWidth[1],s=t.RNG.getUniformInt(n,r),a=(n=o.roomHeight[0],r=o.roomHeight[1],t.RNG.getUniformInt(n,r)),h=e-Math.floor(t.RNG.getUniform()*s),l=i-Math.floor(t.RNG.getUniform()*a);return new this(h,l,h+s-1,l+a-1)},t.Map.Feature.Room.createRandom=function(e,i,o){var n=o.roomWidth[0],r=o.roomWidth[1],s=t.RNG.getUniformInt(n,r),a=(n=o.roomHeight[0],r=o.roomHeight[1],t.RNG.getUniformInt(n,r)),h=e-s-1,l=i-a-1,c=1+Math.floor(t.RNG.getUniform()*h),u=1+Math.floor(t.RNG.getUniform()*l);return new this(c,u,c+s-1,u+a-1)},t.Map.Feature.Room.prototype.addDoor=function(t,e){return this._doors[t+","+e]=1,this},t.Map.Feature.Room.prototype.getDoors=function(t){for(var e in this._doors){var i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this},t.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},t.Map.Feature.Room.prototype.addDoors=function(t){for(var e=this._x1-1,i=this._x2+1,o=this._y1-1,n=this._y2+1,r=e;r<=i;r++)for(var s=o;s<=n;s++)r!=e&&r!=i&&s!=o&&s!=n||t(r,s)||this.addDoor(r,s);return this},t.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},t.Map.Feature.Room.prototype.isValid=function(t,e){for(var i=this._x1-1,o=this._x2+1,n=this._y1-1,r=this._y2+1,s=i;s<=o;s++)for(var a=n;a<=r;a++)if(s==i||s==o||a==n||a==r){if(!t(s,a))return!1}else if(!e(s,a))return!1;return!0},t.Map.Feature.Room.prototype.create=function(t){for(var e=this._x1-1,i=this._x2+1,o=this._y1-1,n=this._y2+1,r=e;r<=i;r++)for(var s=o;s<=n;s++)t(r,s,r+","+s in this._doors?2:r==e||r==i||s==o||s==n?1:0)},t.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},t.Map.Feature.Room.prototype.getLeft=function(){return this._x1},t.Map.Feature.Room.prototype.getRight=function(){return this._x2},t.Map.Feature.Room.prototype.getTop=function(){return this._y1},t.Map.Feature.Room.prototype.getBottom=function(){return this._y2},t.Map.Feature.Corridor=function(t,e,i,o){this._startX=t,this._startY=e,this._endX=i,this._endY=o,this._endsWithAWall=!0},t.Map.Feature.Corridor.extend(t.Map.Feature),t.Map.Feature.Corridor.createRandomAt=function(e,i,o,n,r){var s=r.corridorLength[0],a=r.corridorLength[1],h=t.RNG.getUniformInt(s,a);return new this(e,i,e+o*h,i+n*h)},t.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},t.Map.Feature.Corridor.prototype.isValid=function(t,e){var i=this._startX,o=this._startY,n=this._endX-i,r=this._endY-o,s=1+Math.max(Math.abs(n),Math.abs(r));n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));for(var a=r,h=-n,l=!0,c=0;c<s;c++){var u=i+c*n,p=o+c*r;if(e(u,p)||(l=!1),t(u+a,p+h)||(l=!1),t(u-a,p-h)||(l=!1),!l){s=c,this._endX=u-n,this._endY=p-r;break}}if(0==s)return!1;if(1==s&&t(this._endX+n,this._endY+r))return!1;var _=!t(this._endX+n+a,this._endY+r+h),d=!t(this._endX+n-a,this._endY+r-h);return this._endsWithAWall=t(this._endX+n,this._endY+r),!_&&!d||!this._endsWithAWall},t.Map.Feature.Corridor.prototype.create=function(t){var e=this._startX,i=this._startY,o=this._endX-e,n=this._endY-i,r=1+Math.max(Math.abs(o),Math.abs(n));o&&(o/=Math.abs(o)),n&&(n/=Math.abs(n));for(var s=0;s<r;s++)t(e+s*o,i+s*n,0);return!0},t.Map.Feature.Corridor.prototype.createPriorityWalls=function(t){if(this._endsWithAWall){var e=this._startX,i=this._startY,o=this._endX-e,n=this._endY-i;o&&(o/=Math.abs(o)),n&&(n/=Math.abs(n));var r=n,s=-o;t(this._endX+o,this._endY+n),t(this._endX+r,this._endY+s),t(this._endX-r,this._endY-s)}},t.Noise=function(){},t.Noise.prototype.get=function(t,e){},t.Noise.Simplex=function(e){t.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var i=[],o=e||256,n=0;n<o;n++)i.push(n);for(i=i.randomize(),this._perms=[],this._indexes=[],n=0;n<2*o;n++)this._perms.push(i[n%o]),this._indexes.push(this._perms[n]%this._gradients.length)},t.Noise.Simplex.extend(t.Noise),t.Noise.Simplex.prototype.get=function(t,e){var i,o,n,r=this._perms,s=this._indexes,a=r.length/2,h=this._G2,l=0,c=0,u=0,p=(t+e)*this._F2,_=Math.floor(t+p),d=Math.floor(e+p),f=(_+d)*h,g=t-(_-f),m=e-(d-f);g>m?(o=1,n=0):(o=0,n=1);var y=g-o+h,v=m-n+h,w=g-1+2*h,S=m-1+2*h,M=_.mod(a),T=d.mod(a),E=.5-g*g-m*m;E>=0&&(E*=E,i=s[M+r[T]],l=E*E*((x=this._gradients[i])[0]*g+x[1]*m));var b=.5-y*y-v*v;b>=0&&(b*=b,i=s[M+o+r[T+n]],c=b*b*((x=this._gradients[i])[0]*y+x[1]*v));var x,O=.5-w*w-S*S;return O>=0&&(O*=O,i=s[M+1+r[T+1]],u=O*O*((x=this._gradients[i])[0]*w+x[1]*S)),70*(l+c+u)},t.FOV=function(t,e){for(var i in this._lightPasses=t,this._options={topology:8},e)this._options[i]=e[i]},t.FOV.prototype.compute=function(t,e,i,o){},t.FOV.prototype._getCircle=function(e,i,o){var n,r,s,a=[];switch(this._options.topology){case 4:r=1,s=[0,1],n=[t.DIRS[8][7],t.DIRS[8][1],t.DIRS[8][3],t.DIRS[8][5]];break;case 6:n=t.DIRS[6],r=1,s=[-1,1];break;case 8:n=t.DIRS[4],r=2,s=[-1,1]}for(var h=e+s[0]*o,l=i+s[1]*o,c=0;c<n.length;c++)for(var u=0;u<o*r;u++)a.push([h,l]),h+=n[c][0],l+=n[c][1];return a},t.FOV.DiscreteShadowcasting=function(e,i){t.FOV.call(this,e,i)},t.FOV.DiscreteShadowcasting.extend(t.FOV),t.FOV.DiscreteShadowcasting.prototype.compute=function(t,e,i,o){if(this._coords,this._map,o(t,e,0,1),this._lightPasses(t,e))for(var n,r,s,a,h,l=[],c=1;c<=i;c++)for(var u=this._getCircle(t,e,c),p=360/u.length,_=0;_<u.length;_++)if(s=u[_][0],a=u[_][1],r=(n=p*(_-.5))+p,h=!this._lightPasses(s,a),this._visibleCoords(Math.floor(n),Math.ceil(r),h,l)&&o(s,a,c,1),2==l.length&&0==l[0]&&360==l[1])return},t.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(t,e,i,o){if(t<0){var n=this._visibleCoords(0,e,i,o),r=this._visibleCoords(360+t,360,i,o);return n||r}for(var s=0;s<o.length&&o[s]<t;)s++;if(s==o.length)return i&&o.push(t,e),!0;var a=0;if(s%2){for(;s<o.length&&o[s]<e;)s++,a++;return 0!=a&&(i&&(a%2?o.splice(s-a,a,e):o.splice(s-a,a)),!0)}for(;s<o.length&&o[s]<e;)s++,a++;return(t!=o[s-a]||1!=a)&&(i&&(a%2?o.splice(s-a,a,t):o.splice(s-a,a,t,e)),!0)},t.FOV.PreciseShadowcasting=function(e,i){t.FOV.call(this,e,i)},t.FOV.PreciseShadowcasting.extend(t.FOV),t.FOV.PreciseShadowcasting.prototype.compute=function(t,e,i,o){if(o(t,e,0,1),this._lightPasses(t,e))for(var n,r,s,a,h,l,c=[],u=1;u<=i;u++)for(var p=this._getCircle(t,e,u),_=p.length,d=0;d<_;d++)if(n=p[d][0],r=p[d][1],a=[d?2*d-1:2*_-1,2*_],h=[2*d+1,2*_],s=!this._lightPasses(n,r),(l=this._checkVisibility(a,h,s,c))&&o(n,r,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return},t.FOV.PreciseShadowcasting.prototype._checkVisibility=function(t,e,i,o){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,o)+this._checkVisibility([0,1],e,i,o))/2;for(var n=0,r=!1;n<o.length;){if((h=(l=o[n])[0]*t[1]-t[0]*l[1])>=0){0!=h||n%2||(r=!0);break}n++}for(var s=o.length,a=!1;s--;){var h,l=o[s];if((h=e[0]*l[1]-l[0]*e[1])>=0){0==h&&s%2&&(a=!0);break}}var c,u=!0;if(n==s&&(r||a)?u=!1:r&&a&&n+1==s&&s%2?u=!1:n>s&&n%2&&(u=!1),!u)return 0;var p=s-n+1;if(p%2)if(n%2){var _=o[n];c=(e[0]*_[1]-_[0]*e[1])/(_[1]*e[1]),i&&o.splice(n,p,e)}else c=((_=o[s])[0]*t[1]-t[0]*_[1])/(t[1]*_[1]),i&&o.splice(n,p,t);else{if(!(n%2))return i&&o.splice(n,p,t,e),1;var d=o[n],f=o[s];c=(f[0]*d[1]-d[0]*f[1])/(d[1]*f[1]),i&&o.splice(n,p)}return c/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))},t.FOV.RecursiveShadowcasting=function(e,i){t.FOV.call(this,e,i)},t.FOV.RecursiveShadowcasting.extend(t.FOV),t.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],t.FOV.RecursiveShadowcasting.prototype.compute=function(e,i,o,n){n(e,i,0,1);for(var r=0;r<t.FOV.RecursiveShadowcasting.OCTANTS.length;r++)this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[r],o,n)},t.FOV.RecursiveShadowcasting.prototype.compute180=function(e,i,o,n,r){r(e,i,0,1);var s=(n-1+8)%8,a=(n-2+8)%8,h=(n+1+8)%8;this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[a],o,r),this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[s],o,r),this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[n],o,r),this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[h],o,r)},t.FOV.RecursiveShadowcasting.prototype.compute90=function(e,i,o,n,r){r(e,i,0,1);var s=(n-1+8)%8;this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[n],o,r),this._renderOctant(e,i,t.FOV.RecursiveShadowcasting.OCTANTS[s],o,r)},t.FOV.RecursiveShadowcasting.prototype._renderOctant=function(t,e,i,o,n){this._castVisibility(t,e,1,1,0,o+1,i[0],i[1],i[2],i[3],n)},t.FOV.RecursiveShadowcasting.prototype._castVisibility=function(t,e,i,o,n,r,s,a,h,l,c){if(!(o<n))for(var u=i;u<=r;u++){for(var p=-u-1,_=-u,d=!1,f=0;p<=0;){var g=t+(p+=1)*s+_*a,m=e+p*h+_*l,y=(p-.5)/(_+.5),v=(p+.5)/(_-.5);if(!(v>o)){if(y<n)break;if(p*p+_*_<r*r&&c(g,m,u,1),d){if(!this._lightPasses(g,m)){f=v;continue}d=!1,o=f}else!this._lightPasses(g,m)&&u<r&&(d=!0,this._castVisibility(t,e,u+1,o,y,r,s,a,h,l,c),f=v)}}if(d)break}},t.Color={fromString:function(t){var e,i;if(t in this._cache)e=this._cache[t];else{if("#"==t.charAt(0)){var o=t.match(/[0-9a-f]/gi).map(function(t){return parseInt(t,16)});if(3==o.length)e=o.map(function(t){return 17*t});else{for(var n=0;n<3;n++)o[n+1]+=16*o[n],o.splice(n,1);e=o}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(function(t){return parseInt(t)}):[0,0,0];this._cache[t]=e}return e.slice()},add:function(t,e){for(var i=t.slice(),o=0;o<3;o++)for(var n=1;n<arguments.length;n++)i[o]+=arguments[n][o];return i},add_:function(t,e){for(var i=0;i<3;i++)for(var o=1;o<arguments.length;o++)t[i]+=arguments[o][i];return t},multiply:function(t,e){for(var i=t.slice(),o=0;o<3;o++){for(var n=1;n<arguments.length;n++)i[o]*=arguments[n][o]/255;i[o]=Math.round(i[o])}return i},multiply_:function(t,e){for(var i=0;i<3;i++){for(var o=1;o<arguments.length;o++)t[i]*=arguments[o][i]/255;t[i]=Math.round(t[i])}return t},interpolate:function(t,e,i){arguments.length<3&&(i=.5);for(var o=t.slice(),n=0;n<3;n++)o[n]=Math.round(o[n]+i*(e[n]-t[n]));return o},interpolateHSL:function(t,e,i){arguments.length<3&&(i=.5);for(var o=this.rgb2hsl(t),n=this.rgb2hsl(e),r=0;r<3;r++)o[r]+=i*(n[r]-o[r]);return this.hsl2rgb(o)},randomize:function(e,i){i instanceof Array||(i=Math.round(t.RNG.getNormal(0,i)));for(var o=e.slice(),n=0;n<3;n++)o[n]+=i instanceof Array?Math.round(t.RNG.getNormal(0,i[n])):i;return o},rgb2hsl:function(t){var e,i,o=t[0]/255,n=t[1]/255,r=t[2]/255,s=Math.max(o,n,r),a=Math.min(o,n,r),h=(s+a)/2;if(s==a)e=i=0;else{var l=s-a;switch(i=h>.5?l/(2-s-a):l/(s+a),s){case o:e=(n-r)/l+(n<r?6:0);break;case n:e=(r-o)/l+2;break;case r:e=(o-n)/l+4}e/=6}return[e,i,h]},hsl2rgb:function(t){var e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];var i=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},o=t[1],n=e<.5?e*(1+o):e+o-e*o,r=2*e-n,s=i(r,n,t[0]+1/3),a=i(r,n,t[0]),h=i(r,n,t[0]-1/3);return[Math.round(255*s),Math.round(255*a),Math.round(255*h)]},toRGB:function(t){return"rgb("+this._clamp(t[0])+","+this._clamp(t[1])+","+this._clamp(t[2])+")"},toHex:function(t){for(var e=[],i=0;i<3;i++)e.push(this._clamp(t[i]).toString(16).lpad("0",2));return"#"+e.join("")},_clamp:function(t){return t<0?0:t>255?255:t},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},t.Lighting=function(t,e){this._reflectivityCallback=t,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)},t.Lighting.prototype.setOptions=function(t){for(var e in t)this._options[e]=t[e];return t&&t.range&&this.reset(),this},t.Lighting.prototype.setFOV=function(t){return this._fov=t,this._fovCache={},this},t.Lighting.prototype.setLight=function(e,i,o){var n=e+","+i;return o?this._lights[n]="string"==typeof o?t.Color.fromString(o):o:delete this._lights[n],this},t.Lighting.prototype.clearLights=function(){this._lights={}},t.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},t.Lighting.prototype.compute=function(e){var i={},o={},n={};for(var r in this._lights){var s=this._lights[r];o[r]=[0,0,0],t.Color.add_(o[r],s)}for(var a=0;a<this._options.passes;a++)this._emitLight(o,n,i),a+1!=this._options.passes&&(o=this._computeEmitters(n,i));for(var h in n){var l=h.split(",");e(parseInt(l[0]),parseInt(l[1]),n[h])}return this},t.Lighting.prototype._emitLight=function(t,e,i){for(var o in t){var n=o.split(","),r=parseInt(n[0]),s=parseInt(n[1]);this._emitLightFromCell(r,s,t[o],e),i[o]=1}return this},t.Lighting.prototype._computeEmitters=function(t,e){var i={};for(var o in t)if(!(o in e)){var n=t[o];if(o in this._reflectivityCache)var r=this._reflectivityCache[o];else{var s=o.split(","),a=parseInt(s[0]),h=parseInt(s[1]);r=this._reflectivityCallback(a,h),this._reflectivityCache[o]=r}if(0!=r){for(var l=[],c=0,u=0;u<3;u++){var p=Math.round(n[u]*r);l[u]=p,c+=p}c>this._options.emissionThreshold&&(i[o]=l)}}return i},t.Lighting.prototype._emitLightFromCell=function(t,e,i,o){var n=t+","+e;if(n in this._fovCache)var r=this._fovCache[n];else r=this._updateFOV(t,e);for(var s in r){var a=r[s];if(s in o)var h=o[s];else h=[0,0,0],o[s]=h;for(var l=0;l<3;l++)h[l]+=Math.round(i[l]*a)}return this},t.Lighting.prototype._updateFOV=function(t,e){var i=t+","+e,o={};this._fovCache[i]=o;var n=this._options.range;return this._fov.compute(t,e,n,function(t,e,i,r){var s=r*(1-i/n);0!=s&&(o[t+","+e]=s)}.bind(this)),o},t.Path=function(e,i,o,n){for(var r in this._toX=e,this._toY=i,this._fromX=null,this._fromY=null,this._passableCallback=o,this._options={topology:8},n)this._options[r]=n[r];this._dirs=t.DIRS[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},t.Path.prototype.compute=function(t,e,i){},t.Path.prototype._getNeighbors=function(t,e){for(var i=[],o=0;o<this._dirs.length;o++){var n=this._dirs[o],r=t+n[0],s=e+n[1];this._passableCallback(r,s)&&i.push([r,s])}return i},t.Path.Dijkstra=function(e,i,o,n){t.Path.call(this,e,i,o,n),this._computed={},this._todo=[],this._add(e,i,null)},t.Path.Dijkstra.extend(t.Path),t.Path.Dijkstra.prototype.compute=function(t,e,i){var o=t+","+e;if(o in this._computed||this._compute(t,e),o in this._computed)for(var n=this._computed[o];n;)i(n.x,n.y),n=n.prev},t.Path.Dijkstra.prototype._compute=function(t,e){for(;this._todo.length;){var i=this._todo.shift();if(i.x==t&&i.y==e)return;for(var o=this._getNeighbors(i.x,i.y),n=0;n<o.length;n++){var r=o[n],s=r[0],a=r[1];s+","+a in this._computed||this._add(s,a,i)}}},t.Path.Dijkstra.prototype._add=function(t,e,i){var o={x:t,y:e,prev:i};this._computed[t+","+e]=o,this._todo.push(o)},t.Path.AStar=function(e,i,o,n){t.Path.call(this,e,i,o,n),this._todo=[],this._done={},this._fromX=null,this._fromY=null},t.Path.AStar.extend(t.Path),t.Path.AStar.prototype.compute=function(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;)if(!((r=(l=this._todo.shift()).x+","+l.y)in this._done)){if(this._done[r]=l,l.x==t&&l.y==e)break;for(var o=this._getNeighbors(l.x,l.y),n=0;n<o.length;n++){var r,s=o[n],a=s[0],h=s[1];(r=a+","+h)in this._done||this._add(a,h,l)}}var l;if(l=this._done[t+","+e])for(;l;)i(l.x,l.y),l=l.prev},t.Path.AStar.prototype._add=function(t,e,i){for(var o=this._distance(t,e),n={x:t,y:e,prev:i,g:i?i.g+1:0,h:o},r=n.g+n.h,s=0;s<this._todo.length;s++){var a=this._todo[s],h=a.g+a.h;if(r<h||r==h&&o<a.h)return void this._todo.splice(s,0,n)}this._todo.push(n)},t.Path.AStar.prototype._distance=function(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:var i=Math.abs(t-this._fromX),o=Math.abs(e-this._fromY);return o+Math.max(0,(i-o)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}throw new Error("Illegal topology")},t.Display.Term=function(e){t.Display.Backend.call(this,e),this._cx=-1,this._cy=-1,this._lastColor="",this._options={},this._ox=0,this._oy=0,this._termcolor={}},t.Display.Term.extend(t.Display.Backend),t.Display.Term.prototype.compute=function(e){this._options=e,this._ox=Math.floor((o.stdout.columns-e.width)/2),this._oy=Math.floor((o.stdout.rows-e.height)/2),this._termcolor=new(t.Display.Term[e.termColor.capitalize()])(this._context),this._context._termcolor=this._termcolor},t.Display.Term.prototype.draw=function(t,e){var i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],h=this._ox+i,l=this._oy+n;if(!(h<0||h>=o.stdout.columns)&&!(l<0||l>=o.stdout.rows)&&(h===this._cx&&l===this._cy||(o.stdout.write(this._termcolor.positionToAnsi(h,l)),this._cx=h,this._cy=l),e&&(r||(r=" ")),r)){var c=this._termcolor.colorToAnsi(s,a);c!==this._lastColor&&(o.stdout.write(c),this._lastColor=c);var u=[].concat(r);o.stdout.write(u[0]),this._cx++,this._cx>=o.stdout.columns&&(this._cx=0,this._cy++)}},t.Display.Term.prototype.computeSize=function(t,e){return[o.stdout.columns,o.stdout.rows]},t.Display.Term.prototype.computeFontSize=function(t,e){return 12},t.Display.Term.prototype.eventToPosition=function(t,e){return[t,e]},t.Display.Term.Color=function(t){this._context=t},t.Display.Term.Color.prototype.clearToAnsi=function(t){},t.Display.Term.Color.prototype.colorToAnsi=function(t,e){},t.Display.Term.Color.prototype.positionToAnsi=function(t,e){},t.Display.Term.Xterm=function(e){t.Display.Term.Color.call(this,e)},t.Display.Term.Xterm.extend(t.Display.Term.Color),t.Display.Term.Xterm.prototype.clearToAnsi=function(t){return"[0;48;5;"+this._termcolor(t)+"m[2J"},t.Display.Term.Xterm.prototype.colorToAnsi=function(t,e){return"[0;38;5;"+this._termcolor(t)+";48;5;"+this._termcolor(e)+"m"},t.Display.Term.Xterm.prototype.positionToAnsi=function(t,e){return"["+(e+1)+";"+(t+1)+"H"},t.Display.Term.Xterm.prototype._termcolor=function(e){var i=t.Color.fromString(e);return 36*Math.floor(i[0]*(6/256))+6*Math.floor(i[1]*(6/256))+1*Math.floor(i[2]*(6/256))+16},t)e[i]=t[i];return t})?n.apply(e,r):n)||(t.exports=s)}).call(this,i(36),i(35))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class o{constructor(t,e,i){this.x=t,this._height=e,this.width=i,this.messages=[]}static fromOtherMessageLog(t){const e=new o(t.x,t._height,t.width);return e.messages=[...e.messages],e}addMessage(t){this.messages.push(t),this.sliceExcessMessages()}set height(t){this._height=t,this.sliceExcessMessages()}sliceExcessMessages(){if(this.messages.length>this._height){const t=this.messages.length-this._height;this.messages=this.messages.slice(t)}}}e.MessageLog=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Stairs=class{constructor(t){this.floor=t}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Stairs",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(3),n=i(0);e.LightningScroll=class{constructor(t,e,i){this.damage=t,this.maxRange=e,this._name="Lightning Scroll",i&&(this._name=i)}use(t,e,i){let r=[],s=[];i.compute(t.x,t.y,o.CONSTANTS.PLAYER_FOV,(t,i,o,n)=>{s=s.concat(e.filter(e=>e.fighter&&e.x===t&&e.y===i))});const a=s.map((e,i)=>({idx:i,dist:t.distanceTo(e)})).filter(t=>t.dist<this.maxRange).sort(t=>t.dist);if(a.length>1){const t=s[a[1].idx];r.push({consumed:!0,message:new n.Message(`A lightning bolt strikes ${t.name} for ${this.damage} damage.`,"white"),target:t}),r=r.concat(t.fighter.takeDamage(this.damage))}else r.push({consumed:!1,message:new n.Message("There are no targets in range.","red")});return r}get name(){return this._name}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="LightningScroll",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(1),n=i(0);e.HealingPotion=class{constructor(t,e){this.healAmount=t,this._name="Healing Potion",e&&(this._name=e)}use(t,e){const i=[];return t.fighter?t.fighter.currHp>=o.Fighter.getMaxHp(t.fighter)?(i.push({consumed:!1,message:new n.Message("You are already at full health.","yellow")}),i):t.fighter.currHp<=0?(i.push({consumed:!1,message:new n.Message("You are dead. The potion doesn't really help.","yellow")}),i):(i.push({consumed:!0,message:new n.Message("Your wounds start to feel better!","green")}),t.fighter.currHp+=this.healAmount,t.fighter.currHp>o.Fighter.getMaxHp(t.fighter)&&(t.fighter.currHp=o.Fighter.getMaxHp(t.fighter)),i):(i.push({consumed:!1,message:new n.Message(`${t.name} tries to use a healing potion, but realizes it can't do so.`,"red")}),i)}get name(){return this._name}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="HealingPotion",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(20),n=i(4),r=i(2),s=i(18),a=i(14),h=i(13),l=i(5);e.itemFromObject=function(t){switch(t.name){case"Confusion Scroll":return new n.Entity(t.id,0,0,"lightpink","#",!1,"Confusion Scroll",l.RenderOrder.ITEM,null,null,new o.ConfusionScroll(t.item.numTurns));case"Fireball Scroll":return new n.Entity(t.id,0,0,"red","#",!1,"Fireball Scroll",l.RenderOrder.ITEM,null,null,new s.FireballScroll(t.item.damage,t.item.radius));case"Healing Potion":return new n.Entity(t.id,0,0,"violet","!",!1,"Healing Potion",l.RenderOrder.ITEM,null,null,new a.HealingPotion(t.item.healAmount));case"Lightning Scroll":return new n.Entity(t.id,0,0,"yellow","#",!1,"Lightning Scroll",l.RenderOrder.ITEM,null,null,new h.LightningScroll(t.item.damage,t.item.maxRange));case"Shield":return new n.Entity(t.id,0,0,"darkorange","[",!1,"Shield",l.RenderOrder.ITEM,null,null,null,null,null,null,null,new r.Equippable(r.EquipmentSlot.OFF_HAND,0,1,0));case"Sword":return new n.Entity(t.id,0,0,"skyblue","刀",!1,"Sword",l.RenderOrder.ITEM,null,null,null,null,null,null,null,new r.Equippable(r.EquipmentSlot.MAIN_HAND,3,0,0))}return null}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(6),n=i(15),r=i(0);e.inventoryFromObject=function(t){switch(t._type){case"Inventory":const e=new s(t.capacity);for(const i of t.items)e.items.push(n.itemFromObject(i));return e}return null};class s{constructor(t){this.capacity=t,this.items=[]}addItem(t){const e=[];return this.items.length>=this.capacity?e.push({message:new r.Message("Your inventory is full.","yellow")}):(e.push({itemAdded:t,message:new r.Message(`You pick up the ${t.name}!`,"blue")}),this.items.push(t)),e}dropItem(t,e){const i=[];if(t>=this.items.length||t<0)return i.push({message:new r.Message(`${this.owner.name} tries to drop an item that they don't have. How silly!`,"red")}),i;const n=this.items[t];return this.owner.equipment&&n.equippable&&this.owner.equipment.equipped.includes(n.equippable)&&o.Equipment.toggleEquip(this.owner.equipment,n.equippable),n.x=this.owner.x,n.y=this.owner.y,this.items.splice(t,1),i.push({itemDropped:n,message:new r.Message(`You drop the ${n.name}.`,"yellow")}),i}useItem(t,e,i,o,n){let s=[];if(t>=this.items.length||t<0)return s.push({message:new r.Message(`${this.owner.name} tries to use an item that they don't have. How silly!`,"red")}),s;if(!this.items[t].item)return this.items[t].equippable?s.push({equip:this.items[t]}):s.push({message:new r.Message(`The ${this.items[t].name} cannot be used.`,"yellow")}),s;if(this.items[t].item.requiresTarget&&void 0===o&&void 0===n)return s.push({targeting:this.items[t]}),s;const a=this.items[t].item.use(this.owner,e,i,o,n);return a.some(t=>t.consumed)&&this.items.splice(t,1),s=s.concat(a)}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="Inventory",t}}e.Inventory=s},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(29),n=i(4),r=i(6),s=i(2),a=i(1),h=i(16),l=i(15),c=i(9),u=i(12);class p{constructor(t,e,i,o=1){this.height=t,this.width=e,this.entities=i,this.dungeonLevel=o,this.tiles=[];for(let t=0;t<this.width;++t){this.tiles[t]=[];for(let e=0;e<this.height;++e)this.tiles[t].push({blocksSight:!0,isBlocked:!0,isSeen:!1})}}static fromOtherMap(t){const e=[];for(const i of t.entities){const t=new n.Entity(i.id,i.x,i.y,i.color,i.symbol,i.isBlocking,i.name,i.renderOrder);if(i.ai&&(t.ai=o.aiFromObject(i.ai),t.ai.owner=t),i.fighter&&(t.fighter=a.fighterFromObject(i.fighter),t.fighter.owner=t),i.inventory&&(t.inventory=h.inventoryFromObject(i.inventory),t.inventory.owner=t),i.item&&(t.item=l.itemFromObject(i.item).item,t.item.owner=t),i.stairs&&(t.stairs=new u.Stairs(i.stairs.floor),t.stairs.owner=t),i.level&&(t.level=new c.Level(i.level.currentLevel,i.level.currentXp,i.level.levelUpBase,i.level.levelUpFactor),t.level.owner=t),i.equipment){t.equipment=new r.Equipment;for(let e=0;e<t.equipment.equipped.length;++e)if(i.equipment.equipped[e]){const o=i.equipment.equipped[e],n=t.inventory.items.filter(t=>t.id===o._ownerId)[0].equippable;t.equipment.equipped[e]=n}t.equipment.owner=t}i.equippable&&(t.equippable=new s.Equippable(i.equippable.slot,i.equippable.powerBonus,i.equippable.defenseBonus,i.equippable.maxHpBonus),t.equippable.owner=t),e.push(t)}const i=new p(t.height,t.width,e,t.dungeonLevel);for(let e=0;e<i.width;++e)for(let o=0;o<i.height;++o)i.tiles[e][o]=Object.assign({},t.tiles[e][o]);return i}getTile(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.tiles[t][e]}isBlocked(t,e){const i=this.getTile(t,e);return!i||i.isBlocked}}e.GameMap=p},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(3),n=i(0);e.FireballScroll=class{constructor(t,e){this.damage=t,this.radius=e,this.requiresTarget=!0,this.name="Fireball Scroll"}use(t,e,i,r,s){let a=[],h=!1;if(i.compute(t.x,t.y,o.CONSTANTS.PLAYER_FOV,(t,e,i,o)=>{t===r&&e===s&&(h=!0)}),!h)return a.push({consumed:!1,message:new n.Message("You cannot target a tile outside your field of view.","yellow")}),a;a.push({consumed:!0,message:new n.Message(`The fireball explodes, burning everything with ${this.radius} tiles!`,"orange")});const l=e.filter(t=>t.fighter&&t.distanceToPos(r,s)<=this.radius);for(const t of l)a.push({message:new n.Message(`The ${t.name} is burned for ${this.damage} hit points.`,"orange")}),a=a.concat(t.fighter.takeDamage(this.damage));return a}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="FireballScroll",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(1),n=i(0),r=i(7);e.ConfusedMonsterAi=class{constructor(t,e){this.previousAi=t,this.numTurns=e}set owner(t){this._owner=t,this.previousAi.owner=t}get owner(){return this._owner}takeTurn(t,e,i,s){let a=[];if(this.numTurns>0){const t=this.owner.x+r.randomInt(0,2)-1,e=this.owner.y+r.randomInt(0,2)-1;t!==this.owner.x&&e!==this.owner.y&&this.owner.moveTowards(t,e,i,s);const h=r.randomInt(0,100);this.owner.fighter&&0===h&&(a.push({message:new n.Message(`The ${this.owner.name} hurt itself in its confusion!`,"red")}),a=a.concat(this.owner.fighter.takeDamage(o.Fighter.getPower(this.owner.fighter)))),this.numTurns--}else this.owner.ai=this.previousAi,a.push({message:new n.Message(`The ${this.owner.name} is no longer confused!`,"red")});return a}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="ConfusedMonsterAi",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(19),n=i(3),r=i(0);e.ConfusionScroll=class{constructor(t){this.numTurns=t,this.name="Confusion Scroll",this.requiresTarget=!0}use(t,e,i,s,a){const h=[];let l=!1;if(i.compute(t.x,t.y,n.CONSTANTS.PLAYER_FOV,(t,e,i,o)=>{t===s&&e===a&&(l=!0)}),!l)return h.push({consumed:!1,message:new r.Message("You cannot target a tile outside your field of view.","yellow")}),h;const c=e.filter(t=>t.ai&&t.x===s&&t.y===a).sort(t=>t.renderOrder);if(c.length<1)return h.push({consumed:!1,message:new r.Message("There is nothing to target at that location.","yellow")}),h;const u=c[c.length-1],p=new o.ConfusedMonsterAi(u.ai,this.numTurns);return p.owner=u,u.ai=p,h.push({consumed:!0,message:new r.Message(`The eyes of the ${u.name} look vacant as it starts to stumble around.`,"lightgreen")}),h}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="ConfusionScroll",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.BasicMonsterAi=class{takeTurn(t,e,i,o){let n=[];const r=this.owner;let s=!1;return e.compute(r.x,r.y,10,(e,i,o,n)=>{e===t.x&&i===t.y&&(s=!0)}),s&&(r.distanceTo(t)>=2?r.moveAstar(t,i,o):t.fighter&&t.fighter.currHp>0&&(n=n.concat(r.fighter.attack(t)))),n}toJSON(){const t=Object.assign({},this);return t._ownerId=t.owner.id,t.owner=void 0,t._type="BasicMonsterAi",t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(21),n=i(20),r=i(4),s=i(2),a=i(1),h=i(18),l=i(17),c=i(14),u=i(13),p=i(28),_=i(7),d=i(27),f=i(26),g=i(5),m=i(12);e.TutorialMapGenerator=class{constructor(){this.entityId=1}generate(t,e,i,o){this.opts={height:t.height||p.DEFAULT_OPTIONS.height,width:t.width||p.DEFAULT_OPTIONS.width,maxRooms:t.maxRooms||p.DEFAULT_OPTIONS.maxRooms,roomMaxSize:t.roomMaxSize||p.DEFAULT_OPTIONS.roomMaxSize,roomMinSize:t.roomMinSize||p.DEFAULT_OPTIONS.roomMinSize};const n=new l.GameMap(this.opts.height,this.opts.width,i,o);let s=0;const a=[];for(let t=0;t<this.opts.maxRooms;++t){const t=_.randomInt(this.opts.roomMinSize,this.opts.roomMaxSize),e=_.randomInt(this.opts.roomMinSize,this.opts.roomMaxSize),r=_.randomInt(0,this.opts.width-e-1),h=_.randomInt(0,this.opts.height-t-1),l=new f.Rect(r,h,e,t);if(!a.some(t=>t.intersects(l))){if(this.createRoom(n,l),0!==s){const[t,e]=l.getCenter(),[i,o]=a[s-1].getCenter();1===_.randomInt(0,1)?(this.createHorizontalTunnel(n,i,t,o),this.createVerticalTunnel(n,o,e,t)):(this.createVerticalTunnel(n,o,e,i),this.createHorizontalTunnel(n,i,t,e))}s++,a.push(l),this.placeEntities(l,i,o)}}const h=a[0].getCenter();e&&(e.x=h[0],e.y=h[1]),n.dungeonLevel>1&&i.push(new r.Entity(this.entityId++,h[0],h[1],"white",">",!1,"Stairs",g.RenderOrder.STAIRS,null,null,null,null,new m.Stairs(n.dungeonLevel-1)));const c=a[a.length-1].getCenter();return i.push(new r.Entity(this.entityId++,c[0],c[1],"white",">",!1,"Stairs",g.RenderOrder.STAIRS,null,null,null,null,new m.Stairs(n.dungeonLevel+1))),n}createHorizontalTunnel(t,e,i,o){if(e<0||i<0||e>this.opts.width||i>this.opts.width)throw new Error(`Out of bounds! (Width: ${this.opts.width}, x1: ${e}, x2: ${i})`);for(let n=Math.min(e,i);n<Math.max(e,i)+1;++n){const e=t.getTile(n,o);e.isBlocked=!1,e.blocksSight=!1}}createVerticalTunnel(t,e,i,o){if(e<0||i<0||e>this.opts.height||i>this.opts.height)throw new Error(`Out of bounds! (Height: ${this.opts.height}, y1: ${e}, y2: ${i})`);for(let n=Math.min(e,i);n<Math.max(e,i)+1;++n){const e=t.getTile(o,n);e.isBlocked=!1,e.blocksSight=!1}}createRoom(t,e){const i=e.getX(),o=e.getY(),n=e.getX2(),r=e.getY2();if(i<0||o<0||n<0||r<0||i>this.opts.width||n>this.opts.width||o>this.opts.height||r>this.opts.height||i>n||o>r)throw new Error("Out of bounds!"+` (Height: ${this.opts.height},`+` Width: ${this.opts.width},`+` x1: ${i}, x2: ${n},`+` y1: ${o}, y2: ${r})`);for(let e=i+1;e<n;++e)for(let i=o+1;i<r;++i){const o=t.getTile(e,i);o.isBlocked=!1,o.blocksSight=!1}}placeEntities(t,e,i){const l=d.fromDungeonLevel([[1,1],[4,2]],i),p=d.fromDungeonLevel([[1,2],[4,3],[6,5]],i),f=_.randomInt(0,l),m=_.randomInt(0,p),y={orc:80,troll:d.fromDungeonLevel([[3,15],[5,30],[7,60]],i)},v={confusionScroll:d.fromDungeonLevel([[2,10]],i),fireballScroll:d.fromDungeonLevel([[6,25]],i),healingPotion:35,lightningScroll:d.fromDungeonLevel([[4,25]],i),shield:d.fromDungeonLevel([[8,15]],i),sword:d.fromDungeonLevel([[4,5]],i)};for(let i=0;i<f;++i){const i=_.randomInt(t.getX()+1,t.getX2()-1),o=_.randomInt(t.getY()+1,t.getY2()-1);if(!e.some(t=>t.x===i&&t.y===o)){let t=null;const a=d.randomChoiceFromMap(v);"lightningScroll"===a?t=new r.Entity(this.entityId++,i,o,"yellow","#",!1,"Lightning Scroll",g.RenderOrder.ITEM,null,null,new u.LightningScroll(40,5)):"fireballScroll"===a?t=new r.Entity(this.entityId++,i,o,"red","#",!1,"Fireball Scroll",g.RenderOrder.ITEM,null,null,new h.FireballScroll(25,3)):"confusionScroll"===a?t=new r.Entity(this.entityId++,i,o,"lightpink","#",!1,"Confusion Scroll",g.RenderOrder.ITEM,null,null,new n.ConfusionScroll(10)):"healingPotion"===a?t=new r.Entity(this.entityId++,i,o,"violet","!",!1,"Healing Potion",g.RenderOrder.ITEM,null,null,new c.HealingPotion(40)):"shield"===a?t=new r.Entity(this.entityId++,i,o,"darkorange","[",!1,"Shield",g.RenderOrder.ITEM,null,null,null,null,null,null,null,new s.Equippable(s.EquipmentSlot.OFF_HAND,0,1,0)):"sword"===a&&(t=new r.Entity(this.entityId++,i,o,"skyblue","刀",!1,"Sword",g.RenderOrder.ITEM,null,null,null,null,null,null,null,new s.Equippable(s.EquipmentSlot.MAIN_HAND,3,0,0))),e.push(t)}}for(let i=0;i<m;++i){const i=_.randomInt(t.getX()+1,t.getX2()-1),n=_.randomInt(t.getY()+1,t.getY2()-1);if(!e.some(t=>t.x===i&&t.y===n)){let t=null;const s=d.randomChoiceFromMap(y);"orc"===s?t=new r.Entity(this.entityId++,i,n,"white","O",!0,"Orc",g.RenderOrder.ACTOR,new a.Fighter(20,0,4,35),new o.BasicMonsterAi):"troll"===s&&(t=new r.Entity(this.entityId++,i,n,"white","T",!0,"Troll",g.RenderOrder.ACTOR,new a.Fighter(30,2,8,100),new o.BasicMonsterAi)),e.push(t)}}}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.saveGame=function(t,e,i,o,n,r){localStorage.setItem("savedGame",JSON.stringify({currentMap:o,entities:e,gameMaps:i,gameState:r,messageLog:n,playerIndex:e.indexOf(t)}))}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.menu=function(t,e,i,o,n,r,s){if(i.length>26)throw new Error("Cannot have a menu with more than 26 options.");const a=Math.floor(r/2-n/2),h=Math.floor(s/2-13.5);t.drawText(a,h,e,n);let l=1;for(const e of i){let i=e;l===o+1&&(i="%b{blue}"+e),t.drawText(a,h+l,i,n),l++}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(17),n=i(11);e.loadGame=function(t){const e={currentMap:t.currentMap,entities:[],gameMaps:[],gameState:null,messageLog:null,player:null};for(const i of t.gameMaps)e.gameMaps.push(o.GameMap.fromOtherMap(i));return e.gameState=t.gameState,e.messageLog=n.MessageLog.fromOtherMessageLog(t.messageLog),e.entities=e.gameMaps[e.currentMap].entities,e.player=e.entities[t.playerIndex],e}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Rect=class{constructor(t,e,i,o){this.x=t,this.y=e,this.x2=t+i,this.y2=e+o}getCenter(){return[Math.floor((this.x+this.x2)/2),Math.floor((this.y+this.y2)/2)]}getX(){return this.x}getY(){return this.y}getX2(){return this.x2}getY2(){return this.y2}intersects(t){return this.x<=t.x2&&this.x2>=t.x&&this.y<=t.y2&&this.y2>=t.y}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(7);function n(t){const e=o.randomInt(0,t.reduce((t,e)=>t+e,0));let i=0,n=0;for(const o of t){if(e<=(i+=o))return n;n+=1}return n}e.fromDungeonLevel=function(t,e){for(const i of t)if(e>=i[0])return i[1];return 0},e.randomChoiceIndex=n,e.randomChoiceFromMap=function(t){return Object.keys(t)[n(Object.values(t))]}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DEFAULT_OPTIONS={height:45,width:80,maxRooms:30,roomMaxSize:10,roomMinSize:6}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(21),n=i(19);e.aiFromObject=function t(e){switch(e._type){case"BasicMonsterAi":return new o.BasicMonsterAi;case"ConfusedMonsterAi":return new n.ConfusedMonsterAi(t(e.previousAi),e.numTurns)}return null}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(1),n=i(3),r=i(0),s=i(22);e.enterStairs=function(t,e,i,a,h=new s.TutorialMapGenerator,l){if(i.some(e=>e.dungeonLevel===t.floor)){const o=i.filter(e=>e.dungeonLevel===t.floor)[0].entities,n=o.filter(t=>t.stairs&&t.stairs.floor===l);return e.x=n[0].x,e.y=n[0].y,[o,t.floor-1]}{const s=[e];return i.push(h.generate({height:n.CONSTANTS.MAP_HEIGHT,width:n.CONSTANTS.MAP_WIDTH},e,s,t.floor)),e.fighter.currHp+=o.Fighter.getMaxHp(e.fighter)/2,e.fighter.currHp>o.Fighter.getMaxHp(e.fighter)&&(e.fighter.currHp=o.Fighter.getMaxHp(e.fighter)),a.addMessage(new r.Message("You rest for a moment, recovering your health.","violet")),[s,t.floor-1]}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(8);e.drawTouchIcons=function(t,e,i,n){const r=document.getElementById("touch-icons");for(;r.firstChild;)r.removeChild(r.firstChild);if(t===o.GameState.SHOW_INVENTORY&&e.inventory.items.length>0){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","data-transfer-download"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"drop"})}),r.appendChild(t)}if(t!==o.GameState.MAIN_MENU&&t!==o.GameState.SHOW_INVENTORY&&t!==o.GameState.TARGETING&&t!==o.GameState.SHOW_CHARACTER_PANEL&&t!==o.GameState.LEVEL_UP&&i.some(t=>t.item&&t.x===e.x&&t.y===e.y)){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","data-transfer-upload"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"pickup"})}),r.appendChild(t)}if(t!==o.GameState.MAIN_MENU&&t!==o.GameState.SHOW_INVENTORY&&t!==o.GameState.TARGETING&&t!==o.GameState.SHOW_CHARACTER_PANEL&&t!==o.GameState.LEVEL_UP&&i.some(t=>t.stairs&&t.x===e.x&&t.y===e.y)){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","elevator"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"enter"})}),r.appendChild(t)}if(t!==o.GameState.MAIN_MENU&&t!==o.GameState.SHOW_INVENTORY&&t!==o.GameState.TARGETING&&t!==o.GameState.SHOW_CHARACTER_PANEL&&t!==o.GameState.LEVEL_UP){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","briefcase"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"open-inventory"})}),r.appendChild(t)}if(t!==o.GameState.MAIN_MENU&&t!==o.GameState.SHOW_INVENTORY&&t!==o.GameState.TARGETING&&t!==o.GameState.SHOW_CHARACTER_PANEL&&t!==o.GameState.LEVEL_UP){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","person"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"open-character-panel"})}),r.appendChild(t)}if(t!==o.GameState.MAIN_MENU&&t!==o.GameState.LEVEL_UP){const t=document.createElement("span");t.setAttribute("class","oi"),t.setAttribute("data-glyph","circle-x"),t.ontouchstart=(t=>{t.stopPropagation(),n({type:"exit"})}),r.appendChild(t)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(8),n=i(0),r=i(5);e.killPlayer=function(t){return t.symbol="%",t.color="darkred",t.renderOrder=r.RenderOrder.CORPSE,{message:new n.Message("You died!","red"),state:o.GameState.PLAYER_DEAD}},e.killMonster=function(t){const e=`${t.name.capitalize()} is dead!`;return t.symbol="%",t.color="darkred",t.isBlocking=!1,t.fighter=null,t.ai=null,t.name=`Remains of ${t.name}`,t.renderOrder=r.RenderOrder.CORPSE,{message:new n.Message(e,"orange")}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(10);e.COLORS={darkGround:o.Color.toRGB([50,50,150]),darkWall:o.Color.toRGB([0,0,100]),lightGround:o.Color.toRGB([200,180,50]),lightWall:o.Color.toRGB([130,110,50])}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=i(1),n=i(9);e.characterScreen=function(t,e,i,r,s){const a=Math.floor(r/2-i/2);let h=Math.floor(s/2-13.5);t.drawText(a,h,"Character information"),e.level&&(h++,t.drawText(a,h,`Level: ${e.level.currentLevel}`),h++,t.drawText(a,h,`Experience: ${e.level.currentXp}/${n.Level.xpToLevel(e.level)}`)),e.fighter&&(h+=2,t.drawText(a,h,`Maximum HP: ${o.Fighter.getMaxHp(e.fighter)}`),h++,t.drawText(a,h,`Attack: ${o.Fighter.getPower(e.fighter)}`),h++,t.drawText(a,h,`Defense: ${o.Fighter.getDefense(e.fighter)}`))}},function(t,e){var i,o,n=t.exports={};function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===r||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:r}catch(t){i=r}try{o="function"==typeof clearTimeout?clearTimeout:s}catch(t){o=s}}();var h,l=[],c=!1,u=-1;function p(){c&&h&&(c=!1,h.length?l=h.concat(l):u=-1,l.length&&_())}function _(){if(!c){var t=a(p);c=!0;for(var e=l.length;e;){for(h=l,l=[];++u<e;)h&&h[u].run();u=-1,e=l.length}h=null,c=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===s||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function f(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];l.push(new d(t,e)),1!==l.length||c||a(_)},d.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=f,n.addListener=f,n.once=f,n.off=f,n.removeListener=f,n.removeAllListeners=f,n.emit=f,n.prependListener=f,n.prependOnceListener=f,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),i(3).main()}]);
//# sourceMappingURL=app.js.map